<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ title }}</title>

  <!-- ✅ Feuille de style principale -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script defer src="{{ url_for('static', filename='js/clock.js') }}"></script>

  <style>
    @keyframes pulse {0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);} }

    .notif {
      margin-top: 8px;
      font-size: 14px;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: 10px;
      text-align: center;
      transition: all 0.3s ease;
    }

.app-logo {
  width: 70px;                /* un peu plus large */
  height: 70px;
  object-fit: contain;
  display: block;
  margin: 10px auto 12px;
  transition: transform 0.2s ease;
  padding: 6px;               /* équilibre visuel */
  background: #fff;           /* fond neutre */
  border-radius: 12px;        /* coins doux */
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.card:hover .app-logo {
  transform: scale(1.08);
}



    .notif.ok {background: rgba(39, 174, 96, 0.1); color: #1e8449;}
    .notif.wait {background: rgba(241, 196, 15, 0.15); color: #b9770e; animation: pulse 2s infinite;}
    .notif.error {background: rgba(231, 76, 60, 0.15); color: #c0392b;}
    .notif.alert {background: rgba(231, 76, 60, 0.1); color: #c0392b; font-weight: 700; animation: pulse 1.5s infinite;}
    .notif.empty {background: rgba(149,165,166,0.15); color:#7f8c8d;}

    /* ✅ Encadré dossiers acceptés */
    .recent-acceptes {
      background: #fff;
      border-radius: 12px;
      padding: 14px 18px;
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
      border: 1px solid rgba(0,0,0,.06);
      margin: 20px 0;
    }
    .recent-acceptes h3 {
      margin: 0 0 8px;
      color: #1e8449;
      font-size: 16px;
      font-weight: 700;
    }
    .recent-acceptes ul {
      list-style: none;
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }
    .recent-acceptes li::before {
      content: "• ";
      color: #27ae60;
      font-weight: bold;
    }
    .recent-acceptes.none {
      opacity: .8;
      color: #555;
    }

    .recent-acceptes.card {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  text-align: left;
  min-width: 300px;
}

  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <img src="{{ url_for('static', filename='img/logo-integrale.png') }}" alt="Logo Intégrale Academy" class="logo">
      <div>
        <h1>Plateforme de gestion <span>Intégrale Academy</span></h1>
        <div id="clock" class="clock">—</div>
      </div>
    </div>
  </header>

  <main class="container">



<div class="grid">
  <a class="card" href="https://assistance-alw9.onrender.com/admin" target="_blank" rel="noopener">
    <div class="emoji">🛟</div>
    <div class="title">Assistance</div>
    <div class="desc">Centre de support</div>
    <div id="notif-assistance" class="notif empty">🛟 Chargement...</div>
  </a>

  <a class="card" href="https://cnapsv5-1.onrender.com/admin" target="_blank" rel="noopener">
    <div class="emoji">📤</div>
    <div class="title">Dépôt dossiers CNAPS</div>
    <div class="desc">Espace d'administration</div>
    <div id="notif-cnaps" class="notif empty">📩 Chargement...</div>
  </a>

  <a class="card" href="https://cnapsv3.onrender.com/" target="_blank" rel="noopener">
    <div class="emoji">📊</div>
    <div class="title">Suivi des demandes CNAPS</div>
    <div class="desc">Surveillance des statuts</div>
    <div id="notif-suivi" class="notif empty">📊 Chargement...</div>
  </a>

  <a class="card" href="https://inscriptions-akou.onrender.com/admin" target="_blank" rel="noopener">
    <div class="emoji">🎓</div>
    <div class="title">Gestion des dossiers stagiaires</div>
    <div class="desc">Inscriptions & pièces</div>
    <div id="notif-stagiaires" class="notif empty">🎓 Chargement...</div>
  </a>

  <a class="card" href="https://vtc-qh20.onrender.com/admin" target="_blank" rel="noopener">
    <div class="emoji">🚖</div>
    <div class="title">Examens VTC</div>
    <div class="desc">Administration examens</div>
    <div id="notif-vtc" class="notif empty">🚖 Chargement...</div>
  </a>

  <a class="card" href="https://bts-wpfy.onrender.com/admin" target="_blank" rel="noopener">
    <div class="emoji">📝</div>
    <div class="title">Contrats d'apprentissage</div>
    <div class="desc">Création & suivi</div>
    <div id="notif-contrats" class="notif empty">📝 Chargement...</div>
  </a>

  <a class="card" href="https://factures-jx8r.onrender.com/login" target="_blank" rel="noopener">
    <div class="emoji">💼</div>
    <div class="title">Gestion des factures</div>
    <div class="desc">Portail de facturation</div>
    <div id="notif-factures" class="notif empty">💼 Chargement...</div>
  </a>

  <a class="card" href="{{ url_for('dotations_home') }}">
    <div class="emoji">🎁</div>
    <div class="title">Gestion des dotations</div>
    <div class="desc">iPad & badge café</div>
    <div id="notif-dotations" class="notif empty">🎁 Chargement...</div>
  </a>

   <a class="card" href="{{ url_for('sessions_home') }}">
    <div class="emoji">📅</div>
    <div class="title">Gestion des sessions</div>
    <div class="desc">Paramétrage interne</div>
    <div id="notif-sessions" class="notif empty">📅 Chargement...</div>
  </a>

  <!-- ✅ Bloc CNAPS acceptés intégré à côté -->
  <div class="card recent-acceptes" id="recent-acceptes" style="padding:15px; text-align:left;">
    <h3>✅ Dossiers CNAPS acceptés cette semaine</h3>
    <div id="liste-acceptes">Chargement...</div>
  </div>
</div> <!-- ← fermeture de la grille -->



<h2 class="section-title">Applications externes</h2>
<div class="grid">
  <a class="card" href="https://integraleacademy.lightning.force.com/" target="_blank" rel="noopener">
    <img src="{{ url_for('static', filename='img/salesforce.png') }}" alt="Salesforce" class="app-logo">
    <div class="title">Salesforce</div>
    <div class="desc">CRM et gestion commerciale</div>
  </a>

  <a class="card" href="https://phone.onoffbusiness.com/calls" target="_blank" rel="noopener">
    <img src="{{ url_for('static', filename='img/onoff.png') }}" alt="Onoff" class="app-logo">
    <div class="title">Onoff</div>
    <div class="desc">Téléphonie business</div>
  </a>

  <a class="card" href="https://calendly.com/" target="_blank" rel="noopener">
    <img src="{{ url_for('static', filename='img/calendly.png') }}" alt="Calendly" class="app-logo">
    <div class="title">Calendly</div>
    <div class="desc">Planification de rendez-vous</div>
  </a>

  <a class="card" href="https://app.quicktalk.com/calls" target="_blank" rel="noopener">
    <img src="{{ url_for('static', filename='img/quicktalk.png') }}" alt="Quicktalk" class="app-logo">
    <div class="title">Quicktalk</div>
    <div class="desc">Standard téléphonique</div>
  </a>
</div>

  </main>

  <footer class="footer">© <span id="year"></span> Intégrale Academy — Tous droits réservés</footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // ✅ Bloc CNAPS Acceptés (7 jours)
    async function updateRecentAcceptes() {
      const box = document.getElementById("liste-acceptes");
      try {
        const r = await fetch("https://cnapsv3.onrender.com/recent_acceptes.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const list = d.recent_acceptes || [];
        if (list.length === 0) {
          box.innerHTML = "<em>Aucun dossier accepté ces 7 derniers jours.</em>";
        } else {
          box.innerHTML = "<ul>" + list.map(x =>
  `<li><strong>${x.nom}</strong> ${x.prenom}${x.session ? " — <em>" + x.session + "</em>" : ""}</li>`
).join("") + "</ul>";
        }
      } catch {
        box.innerHTML = "<span style='color:#c0392b'>Erreur de chargement</span>";
      }
    }

    // --- Assistance ---
    async function updateAssistance() {
      const box = document.getElementById("notif-assistance");
      try {
        const r = await fetch("https://assistance-alw9.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const c = d.a_traiter || 0;
        if (c > 0) {
          box.className = "notif wait";
          box.innerHTML = `🛟 ${c} demande${c>1?"s":""} assistance à traiter`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "✅ Aucune demande assistance en attente";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "🔒 Erreur Assistance";
      }
    }

        // --- DOTATIONS ---
    // --- DOTATIONS ---
async function updateDotations() {
  const box = document.getElementById("notif-dotations");
  try {
    const r = await fetch("https://plateformegestion.onrender.com/dotations_data.json");
    if (!r.ok) throw 0;
    const d = await r.json();

    const a = d.a_distribuer || 0;
    const nr = d.non_restituees || 0;
    const rstu = d.restituees || 0;

    let message = `🎁 ${a} à distribuer, ${nr} non restituée${nr>1?'s':''}, ${rstu} restituée${rstu>1?'s':''}`;

    if (nr > 0) {
      box.className = "notif alert"; // 🔴 rouge (urgences)
    } else if (a > 0) {
      box.className = "notif wait"; // 🟠 orange (à distribuer)
    } else {
      box.className = "notif ok"; // 🟢 vert (tout rendu)
      message = "✅ Tout est OK";
    }

    box.innerHTML = message;

  } catch {
    box.className = "notif error";
    box.innerHTML = "🔒 Erreur Dotations";
  }
}



    // --- CNAPS Dépôt ---
    async function updateCnaps() {
      const box = document.getElementById("notif-cnaps");
      try {
        const r = await fetch("https://cnapsv5-1.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const demandes = Array.isArray(d) ? d : d.demandes || [];
        const total = demandes.length;
        if (total > 0) {
          box.className = "notif wait";
          box.innerHTML = `📩 ${total} demande${total>1?"s":""} CNAPS en attente`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "✅ Aucune demande CNAPS en attente";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "🔒 Erreur CNAPS";
      }
    }

    // --- CNAPS Suivi ---
    async function updateSuivi() {
      const box = document.getElementById("notif-suivi");
      try {
        const r = await fetch("https://cnapsv3.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const c = d.instruction || 0;
        if (c > 0) {
          box.className = "notif wait";
          box.innerHTML = `📊 ${c} dossier${c>1?"s":""} instruction en cours`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "✅ Aucun dossier en instruction";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "🔒 Erreur Suivi CNAPS";
      }
    }

    // --- STAGIAIRES ---
    async function updateStagiaires() {
      const box = document.getElementById("notif-stagiaires");
      try {
        const r = await fetch("https://inscriptions-akou.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const c = (Array.isArray(d)?d:d.dossiers||[]).filter(x=>!x.status||x.status.trim()===""||x.status==="INCOMPLET").length;
        if (c > 0) {
          box.className = "notif wait";
          box.innerHTML = `🎓 ${c} dossier${c>1?"s":""} stagiaire${c>1?"s":""} à traiter`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "✅ Aucun dossier stagiaire en attente";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "🔒 Erreur Inscriptions";
      }
    }

    // --- VTC ---
    async function updateVtc() {
      const box = document.getElementById("notif-vtc");
      try {
        const r = await fetch("https://vtc-qh20.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const c = (Array.isArray(d)?d:[]).filter(x=>!x.statut||x.statut.trim().toUpperCase()==="A INSCRIRE A L'EXAMEN").length;
        if (c > 0) {
          box.className = "notif wait";
          box.innerHTML = `🚖 ${c} dossier${c>1?"s":""} VTC à inscrire`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "✅ Aucun dossier VTC en attente";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "🔒 Erreur VTC";
      }
    }

    // --- CONTRATS ---
    async function updateContrats() {
      const box = document.getElementById("notif-contrats");
      try {
        const r = await fetch("https://bts-wpfy.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const s = d.summary || {};
        const total = (s.a_traiter||0)+(s.signature_en_cours||0)+(s.saisi_entreprise||0);
        if (total > 0) {
          box.className = "notif wait";
          box.innerHTML = `📝 ${s.a_traiter||0} à traiter, ${s.signature_en_cours||0} en signature, ${s.saisi_entreprise||0} en saisie`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "✅ Aucun contrat en attente";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "🔒 Erreur Contrats";
      }
    }

    // --- FACTURES ---
    async function updateFactures() {
      const box = document.getElementById("notif-factures");
      try {
        const r = await fetch("https://factures-jx8r.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const c = d.count || 0;
        if (c > 0) {
          box.className = "notif wait";
          box.innerHTML = `💼 ${c} facture${c>1?"s":""} à régler`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "✅ Aucune facture en attente";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "🔒 Erreur Factures";
      }
    }

    // --- SESSIONS ---
    async function updateSessions() {
      const box = document.getElementById("notif-sessions");
      try {
        const r = await fetch("https://plateformegestion.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const retards = d.retards || 0;
        if (retards > 0) {
          box.className = "notif alert";
          box.innerHTML = `⚠️ ${retards} étape${retards>1?"s":""} en retard`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "✅ Dans les temps";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "🔒 Erreur Sessions";
      }
    }

    // --- Rafraîchissements ---
    function refreshAll() {
  updateAssistance();
  updateCnaps();
  updateSuivi();
  updateStagiaires();
  updateVtc();
  updateContrats();
  updateFactures();
  updateSessions();
  updateDotations(); // ✅ AJOUT ICI
}


    updateRecentAcceptes();
    setInterval(updateRecentAcceptes, 15000);

    refreshAll();
    setInterval(refreshAll, 15000);
  </script>
</body>
</html>
