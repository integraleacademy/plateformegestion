<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .page-header h2 {
      margin: 0;
    }

    .filters-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .filters-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .filter-button {
      border-radius: 999px;
      padding: 6px 14px;
      font-weight: 600;
      font-size: 13px;
      border: none;
      cursor: pointer;
      color: #fff;
    }

    .filter-button.aps {
      background: #4da3ff;
    }

    .filter-button.a3p {
      background: #2ecc71;
    }

    .filter-button.dirigeant {
      background: #f39c12;
    }

    .filter-button.all {
      background: #95a5a6;
    }

    .filter-button.active {
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.35);
    }

    .search-input {
      min-width: 320px;
      width: 320px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      font-weight: 600;
    }

    .helper {
      color: #666;
      font-size: 14px;
      margin-top: 6px;
    }

    .table-wrap {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }

    .price-adaptator-container {
      max-width: 100%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      text-align: left;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .04em;
      color: #777;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0,0,0,.08);
    }

    tbody td {
      padding: 12px 4px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      font-size: 14px;
      vertical-align: middle;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(244, 196, 90, 0.2);
      font-weight: 600;
      font-size: 12px;
      color: #8a5d00;
    }

    .empty-state {
      text-align: center;
      padding: 24px;
      color: #777;
    }

    .modal-subtitle {
      font-size: 14px;
      color: #555;
      margin: 4px 0 0;
    }

    .status-preview {
      background: none;
      border: none;
      padding: 0;
      font: inherit;
      color: #1d4ed8;
      text-decoration: underline;
      cursor: pointer;
    }

    .status-preview:hover {
      color: #1e40af;
    }

    .preview-body {
      margin-top: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #fff;
      padding: 16px;
      max-height: 60vh;
      overflow: auto;
    }

    .proposal-details {
      background: #f8f5ef;
      border-radius: 12px;
      padding: 12px;
      font-size: 14px;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .proposal-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-end;
    }

    .proposal-actions .btn {
      min-width: 220px;
    }

    .proposal-actions .btn.primary {
      background: #2ecc71;
      border-color: #27ae60;
      color: #fff;
    }

    .proposal-actions .btn.secondary {
      background: #f4c45a;
      border-color: #e5b348;
      color: #000;
    }

    .proposed-price.modified {
      color: #1e8449;
      font-weight: 700;
    }

    .btn.danger {
      background: #ff6b6b;
      border-color: #e74c3c;
      color: #fff;
    }

    .row-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
    }

    .bulk-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bulk-actions .btn.danger {
      font-size: 13px;
    }

    .proposal-edit {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    .proposal-edit input {
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.15);
      font-weight: 600;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(46, 204, 113, 0.15);
      color: #1e8449;
    }

    .status-pill.pending {
      background: rgba(149, 165, 166, 0.2);
      color: #566573;
    }

    .status-date {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .dates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .dates-card {
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #fffdf8;
    }

    .dates-card h4 {
      margin: 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #666;
    }

    .dates-grid label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
    }

    .dates-grid input {
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.15);
    }

    .discount-button {
      align-self: flex-start;
      font-size: 13px;
      padding: 6px 12px;
    }

    .discount-price {
      font-size: 13px;
      color: #6b6b6b;
      font-weight: 600;
    }

    @media (max-width: 720px) {
      .filters-toolbar {
        align-items: stretch;
      }

      .search-input {
        width: 100%;
      }

      thead {
        display: none;
      }

      tbody tr {
        display: block;
        padding: 12px 0;
        border-bottom: 1px solid rgba(0,0,0,.08);
      }

      tbody td {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        padding: 6px 0;
      }

      tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #666;
      }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="{{ url_for('static', filename='img/logo-integrale.png') }}" alt="Logo Int√©grale Academy" class="logo">
      <div>
        <a href="{{ url_for('index') }}" class="back">‚Üê Retour</a>
        <h1>Price adaptator</h1>
        <div class="desc">Gestion des prospects et propositions de tarif derni√®re minute</div>
      </div>
    </div>
  </header>

  <main class="container price-adaptator-container">
    <div class="page-header">
      <div>
        <h2>Prospects</h2>
        <div class="helper">Ajoutez un prospect puis g√©n√©rez une proposition personnalis√©e en un clic.</div>
      </div>
      <div class="actions-bar">
        <button class="btn" type="button" id="open-dates-modal">üìÖ Dates des formations</button>
        <button class="btn edit" type="button" id="open-add-modal">‚ûï Ajouter un prospect</button>
        <button class="btn secondary" type="button" id="open-import">üì• Importer Excel</button>
        <input type="file" id="import-file" accept=".xlsx" hidden />
      </div>
    </div>

    <div class="table-wrap">
      <div class="filters-toolbar">
        <div class="filters-group" id="formation-filters">
          <button class="filter-button aps" type="button" data-filter="APS">APS</button>
          <button class="filter-button a3p" type="button" data-filter="A3P">A3P</button>
          <button class="filter-button dirigeant" type="button" data-filter="Dirigeant">DIRIGEANT</button>
          <button class="filter-button all active" type="button" data-filter="ALL">Toutes les formations</button>
        </div>
        <input
          type="search"
          id="prospect-search"
          class="search-input"
          placeholder="Rechercher par nom, pr√©nom ou email"
          autocomplete="off"
        />
        <div class="bulk-actions">
          <button class="btn danger" type="button" id="clear-prospects">SUPPRIMER TOUTES LES LIGNES</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Nom</th>
            <th>Pr√©nom</th>
            <th>CPF</th>
            <th>Tarif propos√©</th>
            <th>Email</th>
            <th>T√©l√©phone</th>
            <th>Formation</th>
            <th>Relance pr√©vue le</th>
            <th>Statut</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="prospects-body"></tbody>
      </table>
      <div class="empty-state" id="empty-state">Aucun prospect enregistr√© pour le moment.</div>
    </div>
  </main>

  <div class="modal" id="add-modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h3>Ajouter un prospect</h3>
          <p class="modal-subtitle">Renseignez les informations du futur stagiaire.</p>
        </div>
        <button class="btn" type="button" data-close>Fermer</button>
      </div>
      <form id="add-form">
        <div class="form-grid">
          <label>Nom
            <input type="text" name="nom" required />
          </label>
          <label>Pr√©nom
            <input type="text" name="prenom" required />
          </label>
          <label>Montant du CPF (‚Ç¨)
            <input type="number" name="cpf" min="0" step="1" required />
          </label>
          <label>Email
            <input type="email" name="email" required />
          </label>
          <label>T√©l√©phone
            <input type="tel" name="telephone" required />
          </label>
          <label>Formation
            <select name="formation" required>
              <option value="">Choisir</option>
              <option value="APS">APS</option>
              <option value="A3P">A3P</option>
              <option value="Dirigeant">Dirigeant</option>
            </select>
          </label>
          <div class="form-actions">
            <button class="btn edit" type="submit">Enregistrer</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="dates-modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h3>Dates des prochaines formations</h3>
          <p class="modal-subtitle">Ces dates seront utilis√©es dans les emails et SMS.</p>
        </div>
        <button class="btn" type="button" data-close>Fermer</button>
      </div>
      <form id="dates-form">
        <div class="dates-grid">
          <div class="dates-card">
            <h4>APS</h4>
            <label>Date de d√©but
              <input type="date" name="APS_start" />
            </label>
            <label>Date de fin
              <input type="date" name="APS_end" />
            </label>
            <input type="hidden" name="APS_discount" />
            <button class="btn discount-button" type="button" data-discount="APS">Remise : ‚Äî</button>
            <div class="discount-price" data-discount-price="APS"></div>
          </div>
          <div class="dates-card">
            <h4>A3P</h4>
            <label>Date de d√©but
              <input type="date" name="A3P_start" />
            </label>
            <label>Date de fin
              <input type="date" name="A3P_end" />
            </label>
            <input type="hidden" name="A3P_discount" />
            <button class="btn discount-button" type="button" data-discount="A3P">Remise : ‚Äî</button>
            <div class="discount-price" data-discount-price="A3P"></div>
          </div>
          <div class="dates-card">
            <h4>Dirigeant</h4>
            <label>Date de d√©but
              <input type="date" name="Dirigeant_start" />
            </label>
            <label>Date de fin
              <input type="date" name="Dirigeant_end" />
            </label>
            <input type="hidden" name="Dirigeant_discount" />
            <button class="btn discount-button" type="button" data-discount="Dirigeant">Remise : ‚Äî</button>
            <div class="discount-price" data-discount-price="Dirigeant"></div>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn edit" type="submit">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="proposal-modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h3>Proposition tarif derni√®re minute</h3>
          <p class="modal-subtitle" id="proposal-subtitle">‚Äî</p>
        </div>
        <button class="btn" type="button" data-close>Fermer</button>
      </div>
      <div class="proposal-details" id="proposal-details"></div>
      <div class="proposal-edit">
        <label for="proposal-price">Tarif derni√®re minute propos√© (‚Ç¨)</label>
        <input type="number" id="proposal-price" min="0" step="1" />
      </div>
      <div class="proposal-actions">
        <button class="btn primary" type="button" id="proposal-accept">Cette proposition me convient</button>
        <button class="btn" type="button" id="proposal-save">Enregistrer la proposition</button>
        <button class="btn secondary" type="button" id="proposal-modify">Modifier la proposition</button>
      </div>
    </div>
  </div>

  <div class="modal" id="preview-modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h3>Pr√©visualisation du mail envoy√©</h3>
          <p class="modal-subtitle" id="preview-subtitle">‚Äî</p>
        </div>
        <button class="btn" type="button" data-close>Fermer</button>
      </div>
      <div><strong>Objet :</strong> <span id="preview-subject">‚Äî</span></div>
      <div class="preview-body" id="preview-body"></div>
    </div>
  </div>

  <script>
    const DEFAULT_DISCOUNT = 30;
    const DATA_ENDPOINT = "{{ url_for('price_adaptator_data') }}";
    const PROSPECTS_ENDPOINT = "{{ url_for('price_adaptator_add_prospect') }}";
    const IMPORT_ENDPOINT = "{{ url_for('price_adaptator_import') }}";
    const DELETE_ENDPOINT = "{{ url_for('price_adaptator_delete_prospect', prospect_id='__id__') }}";
    const CLEAR_ENDPOINT = "{{ url_for('price_adaptator_clear_prospects') }}";
    const DATES_ENDPOINT = "{{ url_for('price_adaptator_save_dates') }}";
    const SEND_ENDPOINT = "{{ url_for('price_adaptator_send') }}";
    const SAVE_PROPOSAL_ENDPOINT = "{{ url_for('price_adaptator_save_proposal', prospect_id='__id__') }}";
    const PREVIEW_ENDPOINT = "{{ url_for('price_adaptator_preview', prospect_id='__id__') }}";
    const formationPrices = {
      APS: 1650,
      A3P: 4200,
      Dirigeant: 4300,
    };
    const formationLabels = {
      APS: "Agent de pr√©vention et de s√©curit√© (APS)",
      A3P: "Agent de protection physique des personnes (A3P)",
      Dirigeant: "Dirigeant d'entreprise de s√©curit√© priv√©e (DESP)",
    };

    const prospectsBody = document.getElementById("prospects-body");
    const emptyState = document.getElementById("empty-state");
    const addModal = document.getElementById("add-modal");
    const proposalModal = document.getElementById("proposal-modal");
    const datesModal = document.getElementById("dates-modal");
    const previewModal = document.getElementById("preview-modal");
    const addForm = document.getElementById("add-form");
    const datesForm = document.getElementById("dates-form");
    const proposalSubtitle = document.getElementById("proposal-subtitle");
    const proposalDetails = document.getElementById("proposal-details");
    const proposalPriceInput = document.getElementById("proposal-price");
    const proposalAcceptButton = document.getElementById("proposal-accept");
    const proposalSaveButton = document.getElementById("proposal-save");
    const proposalModifyButton = document.getElementById("proposal-modify");
    const previewSubtitle = document.getElementById("preview-subtitle");
    const previewSubject = document.getElementById("preview-subject");
    const previewBody = document.getElementById("preview-body");
    const importButton = document.getElementById("open-import");
    const importFileInput = document.getElementById("import-file");
    const searchInput = document.getElementById("prospect-search");
    const formationFilters = document.getElementById("formation-filters");
    const clearProspectsButton = document.getElementById("clear-prospects");

    let prospects = [];
    let activeProspect = null;
    let formationDates = {};
    let activeFormationFilter = "ALL";
    let searchTerm = "";

    const formatCurrency = (value) => new Intl.NumberFormat("fr-FR", {
      style: "currency",
      currency: "EUR",
      maximumFractionDigits: 0,
    }).format(value);

    const applyMinimumPrice = (prospect, value) => {
      const cpfValue = Number(prospect?.cpf) || 0;
      const minPrice = cpfValue + 100;
      if (!Number.isFinite(value)) {
        return minPrice;
      }
      return Math.max(Math.round(value), minPrice);
    };

    const normalizeLastName = (value) => (value || "").trim().toLocaleUpperCase("fr-FR");

    const normalizeFirstName = (value) => {
      const cleaned = (value || "").trim().replace(/\s+/g, " ");
      return cleaned
        .toLocaleLowerCase("fr-FR")
        .replace(/(^\p{L}|\s\p{L}|-\p{L})/gu, (match) => match.toLocaleUpperCase("fr-FR"));
    };

    const loadRemoteData = async () => {
      const response = await fetch(DATA_ENDPOINT);
      if (!response.ok) {
        throw new Error("Impossible de charger les prospects.");
      }
      const data = await response.json();
      prospects = data.prospects || [];
      formationDates = data.dates || {};
    };

    const saveDates = async () => {
      const response = await fetch(DATES_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dates: formationDates }),
      });
      if (!response.ok) {
        throw new Error("Impossible d'enregistrer les dates.");
      }
      const data = await response.json();
      formationDates = data.dates || {};
    };

    const openModal = (modal) => {
      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
    };

    const closeModal = (modal) => {
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
    };

    const formatDateLabel = (value) => {
      if (!value) {
        return "";
      }
      const parts = value.split("-");
      if (parts.length !== 3) {
        return value;
      }
      return `${parts[2]}/${parts[1]}/${parts[0]}`;
    };

    const formatDateFromUTC = (date) => {
      const day = String(date.getUTCDate()).padStart(2, "0");
      const month = String(date.getUTCMonth() + 1).padStart(2, "0");
      const year = date.getUTCFullYear();
      return `${day}/${month}/${year}`;
    };

    const normalizeDiscount = (value) => {
      const parsed = Number(value);
      if (Number.isNaN(parsed)) {
        return DEFAULT_DISCOUNT;
      }
      return Math.min(Math.max(parsed, 0), 100);
    };

    const getDiscountedPrice = (formation, discountValue) => {
      const basePrice = formationPrices[formation] || 0;
      return Math.round(basePrice * (1 - discountValue / 100));
    };

    const updateDiscountButton = (button, value) => {
      const label = Number.isFinite(value) ? `${value}%` : "‚Äî";
      button.textContent = `Remise : ${label}`;
    };

    const updateDiscountPrice = (formation, discountValue) => {
      const price = getDiscountedPrice(formation, discountValue);
      const label = `Prix remis√© : ${formatCurrency(price)}`;
      const priceNode = datesForm.querySelector(`[data-discount-price=\"${formation}\"]`);
      if (priceNode) {
        priceNode.textContent = label;
      }
    };

    const getFollowUpDate = (formation) => {
      const dateRange = formationDates[formation];
      if (!dateRange || !dateRange.start) {
        return "‚Äî";
      }
      const parts = dateRange.start.split("-");
      if (parts.length !== 3) {
        return "‚Äî";
      }
      const [year, month, day] = parts.map(Number);
      if (!year || !month || !day) {
        return "‚Äî";
      }
      const startDate = new Date(Date.UTC(year, month - 1, day));
      startDate.setUTCDate(startDate.getUTCDate() - 21);
      return formatDateFromUTC(startDate);
    };

    const getFilteredProspects = () => {
      const normalizedSearch = searchTerm.trim().toLowerCase();
      return prospects.filter((prospect) => {
        const matchesFormation = activeFormationFilter === "ALL" || prospect.formation === activeFormationFilter;
        if (!matchesFormation) {
          return false;
        }
        if (!normalizedSearch) {
          return true;
        }
        const fields = [
          normalizeLastName(prospect.nom),
          normalizeFirstName(prospect.prenom),
          prospect.email,
        ]
          .filter(Boolean)
          .map((value) => value.toLowerCase());
        return fields.some((value) => value.includes(normalizedSearch));
      });
    };

    const updateFilterButtons = () => {
      if (!formationFilters) {
        return;
      }
      formationFilters.querySelectorAll("button[data-filter]").forEach((button) => {
        const isActive = button.dataset.filter === activeFormationFilter;
        button.classList.toggle("active", isActive);
      });
    };

    const renderTable = () => {
      prospectsBody.innerHTML = "";
      const filteredProspects = getFilteredProspects();
      const hasProspects = prospects.length > 0;
      emptyState.style.display = filteredProspects.length ? "none" : "block";
      emptyState.textContent = hasProspects
        ? "Aucun prospect ne correspond aux filtres."
        : "Aucun prospect enregistr√© pour le moment.";
      if (clearProspectsButton) {
        clearProspectsButton.disabled = !hasProspects;
      }

      filteredProspects.forEach((prospect) => {
        const displayNom = normalizeLastName(prospect.nom);
        const displayPrenom = normalizeFirstName(prospect.prenom);
        const { proposedPrice, isModified } = buildProposal(prospect);
        const statusClass = prospect.sent ? "status-pill" : "status-pill pending";
        const statusLabel = prospect.sent
          ? `<button class="status-preview" type="button" data-preview="${prospect.id}">Voir le mail envoy√©</button>`
          : "En attente";
        const statusDate = prospect.sentAt
          ? `<div class="status-date">${new Date(prospect.sentAt).toLocaleString("fr-FR")}</div>`
          : "";
        const followUpDate = prospect.sent ? "" : getFollowUpDate(prospect.formation);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td data-label="Nom">${displayNom}</td>
          <td data-label="Pr√©nom">${displayPrenom}</td>
          <td data-label="CPF">${formatCurrency(prospect.cpf)}</td>
          <td data-label="Tarif propos√©" class="proposed-price${isModified ? " modified" : ""}">${formatCurrency(proposedPrice)}</td>
          <td data-label="Email">${prospect.email}</td>
          <td data-label="T√©l√©phone">${prospect.telephone}</td>
          <td data-label="Formation"><span class="badge">${prospect.formation}</span></td>
          <td data-label="Relance pr√©vue le">${followUpDate}</td>
          <td data-label="Statut">
            <div class="${statusClass}">${statusLabel}</div>
            ${statusDate}
          </td>
          <td data-label="Action">
            <div class="row-actions">
              <button class="btn edit" type="button" data-propose="${prospect.id}">Faire une proposition</button>
              <button class="btn danger" type="button" data-delete="${prospect.id}">Supprimer</button>
            </div>
          </td>
        `;
        prospectsBody.appendChild(row);
      });
    };

    const resetProposalActions = () => {
      proposalPriceInput.disabled = true;
      proposalModifyButton.textContent = "Modifier la proposition";
      proposalModifyButton.dataset.mode = "edit";
      proposalSaveButton.disabled = true;
    };

    const buildProposal = (prospect) => {
      const basePrice = formationPrices[prospect.formation] || 0;
      const discountValue = normalizeDiscount(formationDates[prospect.formation]?.discount);
      const discountedPrice = getDiscountedPrice(prospect.formation, discountValue);
      const rawProposedPrice = Number.isFinite(prospect.proposed_price) ? prospect.proposed_price : discountedPrice;
      const proposedPrice = applyMinimumPrice(prospect, rawProposedPrice);
      const remaining = Math.max(proposedPrice - prospect.cpf, 0);
      const effectiveDiscount = basePrice
        ? Math.min(Math.max(Math.round((1 - proposedPrice / basePrice) * 100), 0), 100)
        : discountValue;
      const isModified = Math.round(proposedPrice) !== Math.round(discountedPrice);
      return { basePrice, discountedPrice, remaining, discountValue, proposedPrice, effectiveDiscount, isModified };
    };

    const openProposalModal = (prospect) => {
      activeProspect = prospect;
      const { basePrice, proposedPrice, remaining, effectiveDiscount } = buildProposal(prospect);
      const dateRange = formationDates[prospect.formation];
      const dateText = dateRange
        ? `${formatDateLabel(dateRange.start)} au ${formatDateLabel(dateRange.end)}`
        : "dates √† d√©finir";
      const displayNom = normalizeLastName(prospect.nom);
      const displayPrenom = normalizeFirstName(prospect.prenom);
      proposalSubtitle.textContent = `${displayPrenom} ${displayNom} ‚Ä¢ CPF: ${formatCurrency(prospect.cpf)}`;
      proposalDetails.innerHTML = `
        <strong>Formation :</strong> ${formationLabels[prospect.formation] || prospect.formation} (${formatCurrency(basePrice)})<br>
        <strong>Remise derni√®re minute :</strong> ${effectiveDiscount}% appliqu√©e ‚Üí ${formatCurrency(proposedPrice)}<br>
        <strong>Reste √† charge apr√®s CPF :</strong> ${formatCurrency(remaining)}<br>
        <strong>Prochaine session :</strong> ${dateText}
      `;
      proposalPriceInput.value = proposedPrice;
      resetProposalActions();
      openModal(proposalModal);
    };

    const openPreviewModal = async (prospectId) => {
      previewSubtitle.textContent = "Chargement...";
      previewSubject.textContent = "‚Äî";
      previewBody.innerHTML = "";
      openModal(previewModal);
      try {
        const response = await fetch(PREVIEW_ENDPOINT.replace("__id__", prospectId));
        const payload = await response.json();
        if (!response.ok || !payload.ok) {
          throw new Error(payload.error || "Erreur inconnue");
        }
        previewSubtitle.textContent = payload.sent_at
          ? `Envoy√© le ${new Date(payload.sent_at).toLocaleString("fr-FR")}`
          : "Aucun envoi enregistr√©";
        previewSubject.textContent = payload.subject || "‚Äî";
        previewBody.innerHTML = payload.html || "";
      } catch (error) {
        previewSubtitle.textContent = "Impossible de charger le mail.";
        previewBody.textContent = error.message || "Erreur inconnue.";
      }
    };

    const sendProposal = (price) => {
      if (!activeProspect) {
        return;
      }

      const { basePrice, discountValue } = buildProposal(activeProspect);
      const adjustedPrice = applyMinimumPrice(activeProspect, price);
      if (adjustedPrice !== price) {
        proposalPriceInput.value = adjustedPrice;
      }
      const formationName = formationLabels[activeProspect.formation] || activeProspect.formation;
      const dateRange = formationDates[activeProspect.formation];
      const dateText = dateRange
        ? `${formatDateLabel(dateRange.start)} au ${formatDateLabel(dateRange.end)}`
        : "dates √† d√©finir";
      const payload = {
        email: activeProspect.email,
        phone: activeProspect.telephone,
        prenom: activeProspect.prenom,
        formation: activeProspect.formation,
        formation_full: formationName,
        date_text: dateText,
        price: adjustedPrice,
        base_price: basePrice,
        discount_value: discountValue,
      };

      proposalAcceptButton.disabled = true;
      proposalModifyButton.disabled = true;
      fetch(SEND_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...payload, prospect_id: activeProspect.id }),
      })
        .then(async (response) => {
          if (!response.ok) {
            const data = await response.json().catch(() => ({}));
            throw new Error(data.error || "Erreur d'envoi");
          }
          return response.json();
        })
        .then((data) => {
          prospects = data.prospects || prospects;
          renderTable();
          if (data.sms_error && !data.sms_sent) {
            alert(`Email envoy√©. SMS non envoy√©: ${data.sms_error}`);
          } else {
            alert("Proposition envoy√©e par email/SMS.");
          }
          closeModal(proposalModal);
        })
        .catch((error) => {
          alert(`Erreur d'envoi: ${error.message}`);
        })
        .finally(() => {
          proposalAcceptButton.disabled = false;
          proposalModifyButton.disabled = false;
        });
    };

    const saveProposal = (price) => {
      if (!activeProspect) {
        return;
      }
      const adjustedPrice = applyMinimumPrice(activeProspect, price);
      if (adjustedPrice !== price) {
        proposalPriceInput.value = adjustedPrice;
      }
      proposalSaveButton.disabled = true;
      proposalModifyButton.disabled = true;
      fetch(SAVE_PROPOSAL_ENDPOINT.replace("__id__", activeProspect.id), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ price: adjustedPrice }),
      })
        .then(async (response) => {
          if (!response.ok) {
            const data = await response.json().catch(() => ({}));
            throw new Error(data.error || "Erreur d'enregistrement");
          }
          return response.json();
        })
        .then((data) => {
          prospects = data.prospects || prospects;
          renderTable();
          alert("Proposition enregistr√©e.");
        })
        .catch((error) => {
          alert(`Erreur d'enregistrement: ${error.message}`);
        })
        .finally(() => {
          proposalSaveButton.disabled = false;
          proposalModifyButton.disabled = false;
        });
    };

    document.getElementById("open-add-modal").addEventListener("click", () => {
      addForm.reset();
      openModal(addModal);
    });

    importButton.addEventListener("click", () => {
      if (importFileInput) {
        importFileInput.value = "";
        importFileInput.click();
      }
    });

    importFileInput.addEventListener("change", () => {
      const file = importFileInput.files?.[0];
      if (!file) {
        return;
      }
      const formData = new FormData();
      formData.append("file", file);
      importButton.disabled = true;
      fetch(IMPORT_ENDPOINT, {
        method: "POST",
        body: formData,
      })
        .then(async (response) => {
          if (!response.ok) {
            const data = await response.json().catch(() => ({}));
            throw new Error(data.error || "Erreur d'import");
          }
          return response.json();
        })
        .then((data) => {
          prospects = data.prospects || prospects;
          renderTable();
          const errors = data.errors || [];
          const errorMessage = errors.length ? `\nErreurs:\n- ${errors.join("\n- ")}` : "";
          alert(`Import termin√© : ${data.added || 0} ajout√©(s), ${data.skipped || 0} non import√©(s).${errorMessage}`);
        })
        .catch((error) => {
          alert(error.message);
        })
        .finally(() => {
          importButton.disabled = false;
        });
    });

    if (formationFilters) {
      formationFilters.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-filter]");
        if (!button) {
          return;
        }
        activeFormationFilter = button.dataset.filter;
        updateFilterButtons();
        renderTable();
      });
    }

    if (searchInput) {
      searchInput.addEventListener("input", (event) => {
        searchTerm = event.target.value || "";
        renderTable();
      });
    }

    if (clearProspectsButton) {
      clearProspectsButton.addEventListener("click", () => {
        if (!prospects.length) {
          return;
        }
        if (!confirm("Supprimer toutes les lignes ?")) {
          return;
        }
        clearProspectsButton.disabled = true;
        fetch(CLEAR_ENDPOINT, { method: "DELETE" })
          .then(async (response) => {
            if (!response.ok) {
              const data = await response.json().catch(() => ({}));
              throw new Error(data.error || "Suppression impossible");
            }
            return response.json();
          })
          .then((data) => {
            prospects = data.prospects || [];
            renderTable();
          })
          .catch((error) => {
            alert(error.message);
          })
          .finally(() => {
            clearProspectsButton.disabled = !prospects.length;
          });
      });
    }

    document.getElementById("open-dates-modal").addEventListener("click", () => {
      datesForm.reset();
      Object.entries(formationDates).forEach(([formation, range]) => {
        if (!range) {
          return;
        }
        const startInput = datesForm.querySelector(`input[name=\"${formation}_start\"]`);
        const endInput = datesForm.querySelector(`input[name=\"${formation}_end\"]`);
        const discountInput = datesForm.querySelector(`input[name=\"${formation}_discount\"]`);
        const discountButton = datesForm.querySelector(`button[data-discount=\"${formation}\"]`);
        if (startInput) {
          startInput.value = range.start || "";
        }
        if (endInput) {
          endInput.value = range.end || "";
        }
        if (discountInput) {
          const discountValue = normalizeDiscount(range.discount);
          discountInput.value = discountValue;
          if (discountButton) {
            updateDiscountButton(discountButton, discountValue);
            updateDiscountPrice(formation, discountValue);
          }
        }
      });
      datesForm.querySelectorAll("button[data-discount]").forEach((button) => {
        if (!button.textContent.includes("%")) {
          updateDiscountButton(button, DEFAULT_DISCOUNT);
          const input = datesForm.querySelector(`input[name=\"${button.dataset.discount}_discount\"]`);
          if (input && !input.value) {
            input.value = DEFAULT_DISCOUNT;
          }
          updateDiscountPrice(button.dataset.discount, DEFAULT_DISCOUNT);
        }
      });
      openModal(datesModal);
    });

    addModal.addEventListener("click", (event) => {
      if (event.target === addModal || event.target.hasAttribute("data-close")) {
        closeModal(addModal);
      }
    });

    datesModal.addEventListener("click", (event) => {
      if (event.target === datesModal || event.target.hasAttribute("data-close")) {
        closeModal(datesModal);
      }
    });

    proposalModal.addEventListener("click", (event) => {
      if (event.target === proposalModal || event.target.hasAttribute("data-close")) {
        closeModal(proposalModal);
      }
    });

    addForm.addEventListener("submit", (event) => {
      event.preventDefault();
      const formData = new FormData(addForm);
      const cpfValue = Number(formData.get("cpf"));
      if (Number.isNaN(cpfValue) || cpfValue < 0) {
        alert("Merci de renseigner un montant CPF valide.");
        return;
      }

      const prospect = {
        nom: normalizeLastName(formData.get("nom")),
        prenom: normalizeFirstName(formData.get("prenom")),
        cpf: cpfValue,
        email: formData.get("email").trim(),
        telephone: formData.get("telephone").trim(),
        formation: formData.get("formation"),
      };

      fetch(PROSPECTS_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(prospect),
      })
        .then(async (response) => {
          if (!response.ok) {
            const data = await response.json().catch(() => ({}));
            throw new Error(data.error || "Erreur d'enregistrement");
          }
          return response.json();
        })
        .then((data) => {
          prospects = data.prospects || prospects;
          renderTable();
          closeModal(addModal);
        })
        .catch((error) => {
          alert(error.message);
        });
    });

    datesForm.addEventListener("submit", (event) => {
      event.preventDefault();
      const formData = new FormData(datesForm);
      formationDates = {
        APS: {
          start: formData.get("APS_start"),
          end: formData.get("APS_end"),
          discount: normalizeDiscount(formData.get("APS_discount")),
        },
        A3P: {
          start: formData.get("A3P_start"),
          end: formData.get("A3P_end"),
          discount: normalizeDiscount(formData.get("A3P_discount")),
        },
        Dirigeant: {
          start: formData.get("Dirigeant_start"),
          end: formData.get("Dirigeant_end"),
          discount: normalizeDiscount(formData.get("Dirigeant_discount")),
        },
      };
      saveDates()
        .then(() => {
          renderTable();
          closeModal(datesModal);
        })
        .catch((error) => {
          alert(error.message);
        });
    });

    datesForm.addEventListener("click", (event) => {
      const button = event.target.closest("button[data-discount]");
      if (!button) {
        return;
      }
      const formation = button.dataset.discount;
      const input = datesForm.querySelector(`input[name=\"${formation}_discount\"]`);
      const currentValue = normalizeDiscount(input?.value);
      const raw = prompt("Indiquez le pourcentage de remise √† appliquer.", currentValue);
      if (raw === null) {
        return;
      }
      const nextValue = Number(raw);
      if (Number.isNaN(nextValue) || nextValue < 0 || nextValue > 100) {
        alert("Merci de saisir un pourcentage entre 0 et 100.");
        return;
      }
      if (input) {
        input.value = nextValue;
      }
      updateDiscountButton(button, nextValue);
      updateDiscountPrice(formation, nextValue);
    });

    prospectsBody.addEventListener("click", (event) => {
      const deleteButton = event.target.closest("button[data-delete]");
      if (deleteButton) {
        const prospectId = deleteButton.dataset.delete;
        if (!prospectId) {
          return;
        }
        const prospect = prospects.find((item) => item.id === prospectId);
        const nameLabel = prospect ? `${prospect.prenom} ${prospect.nom}` : "ce prospect";
        if (!confirm(`Supprimer ${nameLabel} ?`)) {
          return;
        }
        fetch(DELETE_ENDPOINT.replace("__id__", prospectId), { method: "DELETE" })
          .then(async (response) => {
            if (!response.ok) {
              const data = await response.json().catch(() => ({}));
              throw new Error(data.error || "Suppression impossible");
            }
            return response.json();
          })
          .then((data) => {
            prospects = data.prospects || prospects.filter((item) => item.id !== prospectId);
            renderTable();
          })
          .catch((error) => {
            alert(error.message);
          });
        return;
      }

      const previewButton = event.target.closest("button[data-preview]");
      if (previewButton) {
        openPreviewModal(previewButton.dataset.preview);
        return;
      }

      const proposeButton = event.target.closest("button[data-propose]");
      if (!proposeButton) {
        return;
      }
      const prospect = prospects.find((item) => item.id === proposeButton.dataset.propose);
      if (prospect) {
        openProposalModal(prospect);
      }
    });

    proposalAcceptButton.addEventListener("click", () => {
      const price = Number(proposalPriceInput.value) || 0;
      sendProposal(price);
    });

    proposalModifyButton.addEventListener("click", () => {
      if (proposalModifyButton.dataset.mode === "edit") {
        proposalPriceInput.disabled = false;
        proposalPriceInput.focus();
        proposalModifyButton.textContent = "Envoyer la proposition";
        proposalModifyButton.dataset.mode = "send";
        proposalSaveButton.disabled = false;
        return;
      }

      const price = Number(proposalPriceInput.value) || 0;
      sendProposal(price);
    });

    proposalSaveButton.addEventListener("click", () => {
      const price = Number(proposalPriceInput.value) || 0;
      saveProposal(price);
    });

    loadRemoteData()
      .then(() => {
        updateFilterButtons();
        renderTable();
      })
      .catch((error) => {
        alert(error.message);
      });
  </script>
</body>
</html>
