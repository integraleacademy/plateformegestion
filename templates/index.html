<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script defer src="{{ url_for('static', filename='js/clock.js') }}"></script>
  <style>
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(10px); }
      to { opacity:1; transform:translateY(0); }
    }

    @keyframes pulse {
      0% { transform:scale(1); }
      50% { transform:scale(1.08); }
      100% { transform:scale(1); }
    }

    #cnaps-alert, #stagiaires-alert {
      margin:40px auto 0;
      max-width:600px;
      text-align:center;
      animation:fadeIn 0.6s ease-in;
    }

    .alert-box {
      background:linear-gradient(135deg, #2ecc71, #27ae60);
      color:white;
      font-weight:600;
      padding:18px 25px;
      border-radius:14px;
      font-size:18px;
      box-shadow:0 4px 10px rgba(0,0,0,0.15);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:background 0.3s ease;
    }

    .active .alert-box {
      animation:pulse 1.8s infinite;
    }

    .alert-box.ok {
      background:linear-gradient(135deg, #27ae60, #1e8449);
    }

    .alert-box.empty {
      background:linear-gradient(135deg, #95a5a6, #7f8c8d);
    }

    .alert-box.error {
      background:linear-gradient(135deg, #e74c3c, #c0392b);
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <img src="{{ url_for('static', filename='img/logo-integrale.png') }}" alt="Logo IntÃ©grale Academy" class="logo">
      <div>
        <h1>Plateforme de gestion <span>IntÃ©grale Academy</span></h1>
        <div id="clock" class="clock">â€”</div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Section interne -->
    <div class="grid">
      <a class="card" href="https://assistance-alw9.onrender.com/admin" target="_blank" rel="noopener">
        <div class="emoji">ğŸ›Ÿ</div>
        <div class="title">Assistance</div>
        <div class="desc">AccÃ©der au centre d'aide</div>
      </a>

      <a class="card" href="https://cnapsv3.onrender.com/" target="_blank" rel="noopener">
        <div class="emoji">ğŸ›°ï¸</div>
        <div class="title">Suivi demandes CNAPS</div>
        <div class="desc">Tableau de suivi</div>
      </a>

      <a class="card" href="https://cnapsv5-1.onrender.com/admin" target="_blank" rel="noopener">
        <div class="emoji">ğŸ“¤</div>
        <div class="title">DÃ©pÃ´t dossiers CNAPS</div>
        <div class="desc">Espace d'administration</div>
      </a>

      <a class="card" href="https://bts-wpfy.onrender.com/admin" target="_blank" rel="noopener">
        <div class="emoji">ğŸ“</div>
        <div class="title">Gestion contrats d'apprentissage</div>
        <div class="desc">CrÃ©ation & suivi</div>
      </a>

      <a class="card" href="https://vtc-qh20.onrender.com/admin" target="_blank" rel="noopener">
        <div class="emoji">ğŸš–</div>
        <div class="title">Examens VTC</div>
        <div class="desc">Administration examens</div>
      </a>

      <a class="card" href="https://inscriptions-akou.onrender.com/admin" target="_blank" rel="noopener">
        <div class="emoji">ğŸ“</div>
        <div class="title">Gestions des dossiers stagiaires</div>
        <div class="desc">Inscriptions & piÃ¨ces</div>
      </a>

      <a class="card" href="https://factures-jx8r.onrender.com/login" target="_blank" rel="noopener">
        <div class="emoji">ğŸ’¶</div>
        <div class="title">Gestion des factures</div>
        <div class="desc">Portail de facturation</div>
      </a>

      <a class="card" href="{{ url_for('sessions_home') }}">
        <div class="emoji">ğŸ“…</div>
        <div class="title">Gestion des sessions</div>
        <div class="desc">ParamÃ©trage interne</div>
      </a>
    </div>

    <!-- Section externe -->
    <h2 class="section-title">Applications externes</h2>
    <div class="grid">
      <a class="card" href="https://integraleacademy.lightning.force.com/" target="_blank" rel="noopener">
        <div class="emoji">âš¡</div>
        <div class="title">Salesforce</div>
        <div class="desc">CRM et gestion commerciale</div>
      </a>

      <a class="card" href="https://phone.onoffbusiness.com/calls" target="_blank" rel="noopener">
        <div class="emoji">ğŸ“±</div>
        <div class="title">Onoff</div>
        <div class="desc">TÃ©lÃ©phonie business</div>
      </a>

      <a class="card" href="https://calendly.com/" target="_blank" rel="noopener">
        <div class="emoji">ğŸ“†</div>
        <div class="title">Calendly</div>
        <div class="desc">Planification de rendez-vous</div>
      </a>

      <a class="card" href="https://app.quicktalk.com/calls" target="_blank" rel="noopener">
        <div class="emoji">â˜ï¸</div>
        <div class="title">Quicktalk</div>
        <div class="desc">Standard tÃ©lÃ©phonique</div>
      </a>
    </div>

    <!-- ğŸ”” Suivi des dÃ©pÃ´ts CNAPS -->
    <div id="cnaps-alert">
      <div id="cnaps-count" class="alert-box empty">
        ğŸ“© Chargement des demandes CNAPS...
      </div>
    </div>

    <!-- ğŸ“ Suivi des dossiers stagiaires -->
    <div id="stagiaires-alert">
      <div id="stagiaires-count" class="alert-box empty">
        ğŸ“ Chargement des dossiers stagiaires...
      </div>
    </div>
  </main>

  <footer class="footer">
    Â© <span id="year"></span> IntÃ©grale Academy â€” Tous droits rÃ©servÃ©s
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    async function updateCnapsCount() {
      const countBox = document.getElementById("cnaps-count");
      const alertBox = document.getElementById("cnaps-alert");

      try {
        const response = await fetch("https://cnapsv5-1.onrender.com/data.json");
        if (!response.ok) throw new Error("Erreur HTTP");
        const data = await response.json();

        let count = 0;
        if (Array.isArray(data)) {
          count = data.filter(d => !d.statut || d.statut.trim() === "").length;
        } else if (data.demandes) {
          count = data.demandes.filter(d => !d.statut || d.statut.trim() === "").length;
        }

        if (count > 0) {
          alertBox.style.display = "block";
          alertBox.classList.add("active");
          countBox.className = "alert-box ok";
          countBox.innerHTML = `ğŸ“© <strong>${count}</strong> nouvelle${count > 1 ? 's' : ''} demande${count > 1 ? 's' : ''} CNAPS en attente`;
        } else {
          alertBox.style.display = "block";
          alertBox.classList.remove("active");
          countBox.className = "alert-box empty";
          countBox.innerHTML = `âœ… Aucune demande CNAPS en attente`;
        }
      } catch (error) {
        console.error("Erreur rÃ©cupÃ©ration CNAPS:", error);
        countBox.className = "alert-box error";
        countBox.innerHTML = "ğŸ”’ Impossible de contacter la plateforme CNAPS";
      }
    }

    async function updateStagiairesCount() {
      const countBox = document.getElementById("stagiaires-count");
      const alertBox = document.getElementById("stagiaires-alert");

      try {
        const response = await fetch("https://inscriptions-akou.onrender.com/data.json");
        if (!response.ok) throw new Error("Erreur HTTP");
        const data = await response.json();

        let count = 0;
        if (Array.isArray(data)) {
          count = data.filter(d => !d.statut || d.statut.trim() === "" || d.statut.trim().toUpperCase() === "EN ATTENTE").length;
        } else if (data.dossiers) {
          count = data.dossiers.filter(d => !d.statut || d.statut.trim() === "" || d.statut.trim().toUpperCase() === "EN ATTENTE").length;
        }

        if (count > 0) {
          alertBox.style.display = "block";
          alertBox.classList.add("active");
          countBox.className = "alert-box ok";
          countBox.innerHTML = `ğŸ“ <strong>${count}</strong> dossier${count > 1 ? 's' : ''} stagiaire${count > 1 ? 's' : ''} en attente`;
        } else {
          alertBox.style.display = "block";
          alertBox.classList.remove("active");
          countBox.className = "alert-box empty";
          countBox.innerHTML = `âœ… Aucun dossier stagiaire en attente`;
        }
      } catch (error) {
        console.error("Erreur rÃ©cupÃ©ration Stagiaires:", error);
        countBox.className = "alert-box error";
        countBox.innerHTML = "ğŸ”’ Impossible de contacter la plateforme Inscriptions";
      }
    }

    // âš¡ Actualisation auto toutes les 15 secondes
    updateCnapsCount();
    updateStagiairesCount();
    setInterval(updateCnapsCount, 15000);
    setInterval(updateStagiairesCount, 15000);
  </script>
</body>
</html>
