<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ContrÃ´le formateur</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body>

<!-- ğŸ”” Message sauvegardÃ© -->
<div id="save-toast"
     style="position:fixed;top:20px;left:50%;transform:translateX(-50%);
            background:#27ae60;color:white;padding:10px 20px;border-radius:8px;
            font-size:14px;box-shadow:0 4px 10px rgba(0,0,0,0.15);
            display:none;z-index:999;font-weight:600;">
  âœ”ï¸ SauvegardÃ©
</div>

<div id="formateur-detail"
     data-fid="{{ formateur.id }}"
     style="max-width:1100px;margin:30px auto;background:#fff;padding:25px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08);">

  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
    <div>
      <a href="{{ url_for('formateurs_home') }}" style="font-size:13px;text-decoration:none;">â¬…ï¸ Retour Ã  la liste</a>
      <h2 style="margin:6px 0 0;">
        ğŸ‘¨â€ğŸ« {{ formateur.prenom }} {{ formateur.nom|upper }}
      </h2>
  
<div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
  
  <!-- ğŸ“¦ Export ZIP -->
  <a href="{{ url_for('export_formateur_dossier', fid=formateur.id) }}"
     style="padding:8px 16px;background:#27ae60;color:white;border-radius:8px;
            font-weight:600;font-size:13px;text-decoration:none;">
    ğŸ“¦ Exporter le dossier
  </a>

  <!-- ğŸ–¨ï¸ Impression -->
  <a href="{{ url_for('print_formateur_dossier', fid=formateur.id) }}"
     target="_blank"
     style="padding:8px 16px;background:#555;color:white;border-radius:8px;
            font-weight:600;font-size:13px;text-decoration:none;">
    ğŸ–¨ï¸ Imprimer le dossier
  </a>

  <!-- ğŸ“§ ENVOI MAIL FORMATEUR (CE QUI MANQUAIT) -->
  <form method="POST"
        action="{{ url_for('send_formateur_relance', fid=formateur.id) }}"
        style="display:inline;">
    <button type="submit"
            style="padding:8px 16px;background:#e67e22;color:white;border:none;
                   border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;">
      ğŸ“§ Relancer le formateur
    </button>
  </form>

</div>



      <div style="font-size:13px;color:#555;margin-top:4px;">
        {{ formateur.email or "Email : â€”" }} â€¢ {{ formateur.telephone or "TÃ©lÃ©phone : â€”" }}
      </div>
      {% if formateur.last_relance %}
  <div style="margin-top:6px;font-size:13px;color:#e67e22;font-weight:600;">
    ğŸ“§ DerniÃ¨re relance : {{ formateur.last_relance }}
  </div>



      
{% endif %}

            <!-- ğŸ”‘ GESTION DE LA CLÃ‰ -->
<div id="cle-box"
     style="margin-top:14px;padding:14px 16px;border-radius:12px;
            background:#f8f9fa;border:1px solid #e0e0e0;
            display:flex;gap:16px;flex-wrap:wrap;align-items:center;">

  <strong style="font-size:14px;">ğŸ”‘ ClÃ© :</strong>

  <!-- AttribuÃ©e -->
  <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
    <input type="checkbox" id="cle-attribuee"
           {% if formateur.cle.attribuee %}checked{% endif %}>
    AttribuÃ©e
  </label>

  <!-- NumÃ©ro -->
  <input type="text"
         id="cle-numero"
         placeholder="NÂ° de clÃ©"
         value="{{ formateur.cle.numero }}"
         style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;
                font-size:13px;width:110px;">

  <!-- Statut -->
  <select id="cle-statut"
          style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;
                 font-size:13px;">
    <option value="non_attribuee"
      {% if formateur.cle.statut == "non_attribuee" %}selected{% endif %}>
      Non attribuÃ©e
    </option>
    <option value="attribuee"
      {% if formateur.cle.statut == "attribuee" %}selected{% endif %}>
      AttribuÃ©e
    </option>
    <option value="rendue"
      {% if formateur.cle.statut == "rendue" %}selected{% endif %}>
      Rendue
    </option>
    <option value="non_rendue"
      {% if formateur.cle.statut == "non_rendue" %}selected{% endif %}>
      Non rendue
    </option>
  </select>
  </div> <!-- fin cle-box -->


<!-- ğŸ« BADGE BARRIÃˆRE -->
<div id="badge-box"
     style="margin-top:12px;padding:14px 16px;border-radius:12px;
            background:#f8f9fa;border:1px solid #e0e0e0;
            display:flex;gap:16px;flex-wrap:wrap;align-items:center;">

  <strong style="font-size:14px;">ğŸ« Badge barriÃ¨re :</strong>

  <!-- AttribuÃ© -->
  <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
    <input type="checkbox" id="badge-attribue"
           {% if formateur.badge.attribue %}checked{% endif %}>
    AttribuÃ©
  </label>

  <!-- NumÃ©ro -->
  <input type="text"
         id="badge-numero"
         placeholder="NÂ° badge"
         value="{{ formateur.badge.numero }}"
         style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;
                font-size:13px;width:110px;">

  <!-- Statut -->
  <select id="badge-statut"
          style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;
                 font-size:13px;">
    <option value="non_attribue"
      {% if formateur.badge.statut == "non_attribue" %}selected{% endif %}>
      Non attribuÃ©
    </option>
    <option value="attribue"
      {% if formateur.badge.statut == "attribue" %}selected{% endif %}>
      AttribuÃ©
    </option>
    <option value="rendu"
      {% if formateur.badge.statut == "rendu" %}selected{% endif %}>
      Rendu
    </option>
    <option value="non_rendu"
      {% if formateur.badge.statut == "non_rendu" %}selected{% endif %}>
      Non rendu
    </option>
  </select>

</div>



  

</div>

    </div>
  </div>

  <hr style="margin:15px 0;">

  <!-- Ajouter une nouvelle ligne -->
  <form method="POST" action="{{ url_for('add_formateur_document', fid=formateur.id) }}" style="display:flex;gap:10px;align-items:baseline;margin-bottom:15px;flex-wrap:wrap;">
    <div style="flex:1 1 250px;">
      <label>Ajouter une nouvelle ligne de contrÃ´le :</label>
      <input type="text" name="label" placeholder="IntitulÃ© du document..." required
             style="width:100%;padding:6px 8px;border-radius:6px;border:1px solid #ddd;">
    </div>
    <button type="submit" style="padding:7px 14px;border:none;border-radius:8px;background:#2980b9;color:#fff;font-weight:600;cursor:pointer;">
      â• Ajouter une ligne
    </button>
  </form>

  <button onclick="toggleNonConcerne()" 
        style="margin-bottom:15px;padding:8px 12px;background:#ddd;border:none;
               border-radius:6px;cursor:pointer;font-size:13px;">
  ğŸ‘ï¸ Afficher / Masquer les documents non concernÃ©s
</button>


  <div style="max-width:900px;margin:0 auto;overflow-x:auto;">
    <table style="border-collapse:collapse;font-size:13px;width:auto;">
      <thead>
        <tr style="background:#f4f6f7;">
          <th style="padding:8px;border-bottom:1px solid #e5e5e5;text-align:left;">Ã‰lÃ©ment Ã  contrÃ´ler</th>
          <th style="padding:8px;border-bottom:1px solid #e5e5e5;text-align:left;width:150px;">Date d'expiration</th>
          <th style="padding:8px;border-bottom:1px solid #e5e5e5;text-align:left;width:160px;">Statut</th>
          <th style="padding:8px;border-bottom:1px solid #e5e5e5;text-align:left;">Commentaire</th>
          <th style="padding:8px;border-bottom:1px solid #e5e5e5;text-align:left;width:220px;">PiÃ¨ces jointes</th>
        </tr>
      </thead>

      <tbody>
  {% for doc in formateur.documents %}
  <tr data-doc-id="{{ doc.id }}" class="{% if doc.status == 'non_concerne' %}non-concerne{% endif %}">
    <td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;">
      {{ doc.label }}
    </td>

    <td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;">
      <input
        type="date"
        name="expiration"
        value="{{ doc.expiration or '' }}"
        style="width:100%;padding:4px 6px;border-radius:6px;border:1px solid #ddd;font-size:12px;">
    </td>

    <td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;">
      <select name="status" class="status-select"
        data-status="{{ doc.status }}"
        style="width:100%;padding:4px 6px;border-radius:6px;border:1px solid #ddd;font-size:12px;">
        <option value="non_concerne" {% if doc.status == "non_concerne" %}selected{% endif %}>Non concernÃ©</option>
        <option value="conforme" {% if doc.status == "conforme" %}selected{% endif %}>Conforme</option>
        <option value="non_conforme" {% if doc.status == "non_conforme" %}selected{% endif %}>Non conforme</option>
      </select>
    </td>

    <td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;">
      <textarea
        name="commentaire"
        rows="2"
        style="width:100%;padding:4px 6px;border-radius:6px;border:1px solid #ddd;font-size:12px;">{{ doc.commentaire or "" }}</textarea>
    </td>

    <td style="padding:6px 8px;border-bottom:1px solid #f0f0f0;">
      {% if doc.attachments %}
        <div style="margin-bottom:6px;">
          {% for att in doc.attachments %}
            {% set ext = att.original_name.split('.')[-1]|lower %}
            <div style="margin-bottom:4px; display:flex; align-items:center; gap:6px;">
              {% if ext in ["jpg","jpeg","png","gif","webp"] %}
                <span>ğŸ–¼ï¸</span>
              {% elif ext in ["pdf"] %}
                <span>ğŸ“„</span>
              {% else %}
                <span>ğŸ“</span>
              {% endif %}

              <a href="{{ url_for('download_formateur_attachment',
                                  fid=formateur.id,
                                  doc_id=doc.id,
                                  filename=att.filename) }}"
                 target="_blank"
                 style="font-size:12px;text-decoration:none;color:#007bff;">
                {{ att.original_name }}
              </a>

              <button type="button"
                      class="delete-att"
                      data-doc="{{ doc.id }}"
                      data-file="{{ att.filename }}"
                      title="Supprimer"
                      style="border:none;background:none;color:#c0392b;
                             cursor:pointer;font-size:13px;">
                ğŸ—‘ï¸
              </button>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <input type="file" name="piece_jointe" multiple style="font-size:11px;">
    </td>
  </tr>
  {% endfor %}
</tbody>

    </table>
  </div>

  <p style="margin-top:10px;font-size:12px;color:#666;">
    â„¹ï¸ Tout changement (date, statut, commentaire, piÃ¨ces jointes) est enregistrÃ© automatiquement.
  </p>

</div>

<script>
(function () {

  const toast = document.getElementById("save-toast");

  function showToast() {
    toast.style.display = "block";
    setTimeout(() => { toast.style.display = "none"; }, 1500);
  }

  const container = document.getElementById("formateur-detail");
  if (!container) return;

  const fid = container.dataset.fid;

  // ğŸ¯ Auto-dÃ©tection expiration
  function checkExpiration(row) {
    const dateInput = row.querySelector("input[name='expiration']");
    const statusSelect = row.querySelector("select[name='status']");
    if (!dateInput || !statusSelect) return;

    if (!dateInput.value) return;

    const today = new Date();
    today.setHours(0,0,0,0);

    const exp = new Date(dateInput.value + "T00:00:00");

    if (exp < today) {
      statusSelect.value = "non_conforme";
      updateSelectColor(statusSelect);
    }
  }

  // ğŸ”¥ Fonction couleur statut
  function updateSelectColor(selectEl) {
    const v = selectEl.value;

    selectEl.style.background = "";
    selectEl.style.color = "";

    if (v === "conforme") {
      selectEl.style.background = "#d4edda";
      selectEl.style.color = "#155724";
    } else if (v === "non_conforme") {
      selectEl.style.background = "#f8d7da";
      selectEl.style.color = "#721c24";
    } else if (v === "non_concerne") {
      selectEl.style.background = "#e0e0e0";
      selectEl.style.color = "#000";
    }
  }

  // Couleurs au chargement
  document.querySelectorAll(".status-select").forEach(sel => {
    updateSelectColor(sel);
  });

  function sendUpdate(row) {
    const docId = row.dataset.docId;
    if (!docId) return;

    const url = `/formateurs/${fid}/documents/${docId}/update`;

    const expirationInput = row.querySelector("input[name='expiration']");
    const statusSelect    = row.querySelector("select[name='status']");
    const commentaireArea = row.querySelector("textarea[name='commentaire']");
    const fileInput       = row.querySelector("input[name='piece_jointe']");

    const formData = new FormData();

    if (expirationInput) formData.append("expiration", expirationInput.value || "");
    if (statusSelect)    formData.append("status", statusSelect.value || "");
    if (commentaireArea) formData.append("commentaire", commentaireArea.value || "");
    if (fileInput && fileInput.files.length > 0) {
      Array.from(fileInput.files).forEach(f => {
        formData.append("piece_jointe", f);
      });
    }

    fetch(url, {
      method: "POST",
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      showToast();
    })
    .catch(err => console.error("Erreur sauvegarde :", err));
  }

  document.querySelectorAll("tr[data-doc-id]").forEach(row => {
    const expirationInput = row.querySelector("input[name='expiration']");
    const statusSelect    = row.querySelector("select[name='status']");
    const commentaireArea = row.querySelector("textarea[name='commentaire']");
    const fileInput       = row.querySelector("input[name='piece_jointe']");

    ["change", "blur"].forEach(evt => {
      if (expirationInput)
        expirationInput.addEventListener(evt, () => {
          checkExpiration(row);
          sendUpdate(row);
        });

      if (statusSelect)
        statusSelect.addEventListener(evt, () => {
          updateSelectColor(statusSelect);
          sendUpdate(row);
        });

      if (commentaireArea)
        commentaireArea.addEventListener(evt, () => sendUpdate(row));
    });

    if (fileInput) {
      fileInput.addEventListener("change", () => {
        if (fileInput.files.length > 0) sendUpdate(row);
      });
    }
  });
// ğŸ—‘ï¸ Suppression d'une piÃ¨ce jointe
document.querySelectorAll(".delete-att").forEach(btn => {
  btn.addEventListener("click", () => {

    if (!confirm("Supprimer cette piÃ¨ce jointe ?")) return;

    const docId = btn.dataset.doc;
    const filename = btn.dataset.file;

    fetch(`/formateurs/${fid}/documents/${docId}/attachments/${filename}/delete`, {
      method: "POST"
    })
    .then(r => r.json())
    .then(data => {
      if (data.ok) {
        // retire la ligne visuellement
        btn.parentElement.remove();
        showToast();
      }
    })
    .catch(err => console.error("Erreur suppression PJ :", err));
  });
});

  /* ===============================
   ğŸ”‘ GESTION CLÃ‰ FORMATEUR
================================ */

const cleBox = document.getElementById("cle-box");
const cleAttribuee = document.getElementById("cle-attribuee");
const cleNumero = document.getElementById("cle-numero");
const cleStatut = document.getElementById("cle-statut");

function updateCleColor() {
  if (!cleBox) return;

  cleBox.style.background = "#f8f9fa";
  cleBox.style.borderColor = "#ddd";

  switch (cleStatut.value) {
    case "attribuee":
      cleBox.style.background = "#e8f5e9";
      cleBox.style.borderColor = "#2ecc71";
      break;
    case "rendue":
      cleBox.style.background = "#e3f2fd";
      cleBox.style.borderColor = "#3498db";
      break;
    case "non_rendue":
      cleBox.style.background = "#fdecea";
      cleBox.style.borderColor = "#e74c3c";
      break;
  }
}

function saveCle() {
  fetch(`/formateurs/${fid}/cle/update`, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({
      attribuee: cleAttribuee.checked ? "true" : "false",
      numero: cleNumero.value || "",
      statut: cleStatut.value
    })
  })
  .then(r => r.json())
  .then(data => {
    showToast();
    updateCleColor();
  })
  .catch(err => console.error("Erreur sauvegarde clÃ© :", err));
}

if (cleAttribuee && cleNumero && cleStatut) {

  updateCleColor(); // couleur au chargement

  cleAttribuee.addEventListener("change", saveCle);
  cleNumero.addEventListener("blur", saveCle);
  cleStatut.addEventListener("change", saveCle);
}

  /* ===============================
   ğŸ« GESTION BADGE BARRIÃˆRE
================================ */

const badgeBox = document.getElementById("badge-box");
const badgeAttribue = document.getElementById("badge-attribue");
const badgeNumero = document.getElementById("badge-numero");
const badgeStatut = document.getElementById("badge-statut");

function updateBadgeColor() {
  if (!badgeBox) return;

  badgeBox.style.background = "#f8f9fa";
  badgeBox.style.borderColor = "#ddd";

  switch (badgeStatut.value) {
    case "attribue":
      badgeBox.style.background = "#e8f5e9";
      badgeBox.style.borderColor = "#2ecc71";
      break;
    case "rendu":
      badgeBox.style.background = "#e3f2fd";
      badgeBox.style.borderColor = "#3498db";
      break;
    case "non_rendu":
      badgeBox.style.background = "#fdecea";
      badgeBox.style.borderColor = "#e74c3c";
      break;
  }
}

function saveBadge() {
  fetch(`/formateurs/${fid}/badge/update`, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({
      attribue: badgeAttribue.checked ? "true" : "false",
      numero: badgeNumero.value || "",
      statut: badgeStatut.value
    })
  })
  .then(r => r.json())
  .then(() => {
    showToast();
    updateBadgeColor();
  })
  .catch(err => console.error("Erreur sauvegarde badge :", err));
}

if (badgeAttribue && badgeNumero && badgeStatut) {
  updateBadgeColor();
  badgeAttribue.addEventListener("change", saveBadge);
  badgeNumero.addEventListener("blur", saveBadge);
  badgeStatut.addEventListener("change", saveBadge);
}

  // ğŸ‘ï¸ Afficher / masquer les documents non concernÃ©s
function toggleNonConcerne() {
  document.querySelectorAll(".non-concerne").forEach(row => {
    row.style.display = (row.style.display === "none") ? "" : "none";
  });
}

  // ğŸš« Masquer automatiquement les lignes non concernÃ©es au chargement
document.querySelectorAll(".non-concerne").forEach(row => {
  row.style.display = "none";
});




  

  
})();
</script>

</body>
</html>









