
{% block content %}
<h2>{{ s.formation }} ‚Äî D√©tail</h2>

{% if not s.steps %}
  <p>Aucune √©tape d√©finie pour {{ s.formation }}.</p>
{% else %}
  <style>
    .step-group {margin-bottom: 30px;}
    .group-title {font-size: 20px; margin: 10px 0; font-weight: bold;}
    .step {margin-bottom:10px; padding:10px 15px; border-radius:10px; background:#fafafa; border-left:6px solid transparent;}
    .step-btn {border:none; background:none; font-size:16px; cursor:pointer;}
    .step-btn.done .label {text-decoration:line-through; color:#777;}
    .ok {color:#2ecc71;}
    .late {color:#e74c3c;}
    .future {color:#f39c12;}
  </style>

  {% set upcoming = [] %}
  {% set late = [] %}
  {% set done = [] %}

  {% for i in order %}
    {% set step = s.steps[i] %}
    {% set st = statuses[i] %}
    {% set date_obj = st.deadline | datetime if st.deadline else None %}
    {% if step.done %}
      {% set _ = done.append((i, step, st, date_obj)) %}
    {% elif st.status == "late" %}
      {% set _ = late.append((i, step, st, date_obj)) %}
    {% else %}
      {% set _ = upcoming.append((i, step, st, date_obj)) %}
    {% endif %}
  {% endfor %}

  <div class="step-group">
    <div class="group-title">üîú √âtapes √† venir</div>
    {% if upcoming %}
      {% for i, step, st, date_obj in upcoming %}
        <div class="step" style="border-left-color:#f39c12;">
          <form method="post" action="{{ url_for('toggle_step', sid=s.id) }}#step{{ i }}">
            <input type="hidden" name="index" value="{{ i }}">
            <button type="submit" class="step-btn {% if step.done %}done{% endif %}">
              <span class="icon">‚è≥</span>
              <span class="label">{{ step.name }}</span>
            </button>
          </form>
          {% if st.deadline %}
            {% set diff = (date_obj - now()).days %}
            <div class="future">
              üìÖ √âch√©ance : {{ date_obj.strftime("%d/%m/%Y") }} (dans {{ diff }} jour{% if diff>1 %}s{% endif %})
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p class="muted">Aucune √©tape √† venir.</p>
    {% endif %}
  </div>

  <div class="step-group">
    <div class="group-title">‚ö†Ô∏è √âtapes en retard</div>
    {% if late %}
      {% for i, step, st, date_obj in late %}
        <div class="step" style="border-left-color:#e74c3c;">
          <form method="post" action="{{ url_for('toggle_step', sid=s.id) }}#step{{ i }}">
            <input type="hidden" name="index" value="{{ i }}">
            <button type="submit" class="step-btn {% if step.done %}done{% endif %}">
              <span class="icon">‚ö†Ô∏è</span>
              <span class="label">{{ step.name }}</span>
            </button>
          </form>
          {% if st.deadline %}
            {% set diff = (date_obj - now()).days %}
            <div class="late">
              üö® Retard de {{ diff|abs }} jour{% if diff|abs>1 %}s{% endif %} (pr√©vu {{ date_obj.strftime("%d/%m/%Y") }})
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p class="muted">Aucune √©tape en retard üéâ</p>
    {% endif %}
  </div>

  <div class="step-group">
    <div class="group-title">‚úÖ √âtapes termin√©es</div>
    {% if done %}
      {% for i, step, st, date_obj in done %}
        <div class="step" style="border-left-color:#2ecc71;">
          <form method="post" action="{{ url_for('toggle_step', sid=s.id) }}#step{{ i }}">
            <input type="hidden" name="index" value="{{ i }}">
            <button type="submit" class="step-btn done">
              <span class="icon">‚úÖ</span>
              <span class="label">{{ step.name }}</span>
            </button>
          </form>
          <div class="ok">Termin√© le {{ step.done_at }}</div>
        </div>
      {% endfor %}
    {% else %}
      <p class="muted">Aucune √©tape valid√©e pour le moment.</p>
    {% endif %}
  </div>
{% endif %}
{% endblock %}

