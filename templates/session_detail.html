{% extends "base.html" %}
{% block content %}
<h2>{{ s.formation }} — Détail</h2>

{% if not s.steps %}
  <p>Aucune étape définie pour {{ s.formation }}.</p>
{% else %}
  <div class="steps">
    {% for i in order %}
      {% set step = s.steps[i] %}
      {% set st = statuses[i] %}
      <div class="step" id="step{{ i }}">
        <form method="post" action="{{ url_for('toggle_step', sid=s.id) }}#step{{ i }}">
          <input type="hidden" name="index" value="{{ i }}">
          <button type="submit" class="step-btn {% if step.done %}done{% endif %}">
            <span class="icon">{% if step.done %}✅{% else %}✏️{% endif %}</span>
            <span class="label">{{ step.name }}</span>
          </button>
        </form>

        {% if st.deadline %}
          {% set date_obj = st.deadline | datetime %}
          {% set diff = (date_obj - now()).days %}
          <div class="status">
            {% if step.done %}
              <span class="ok">✅ Terminé le {{ step.done_at }}</span>
            {% elif diff < 0 %}
              ⚠️ Retard de {{ diff|abs }} jour{% if diff|abs > 1 %}s{% endif %} ({{ date_obj.strftime("%d/%m/%Y") }})
            {% elif diff == 0 %}
              📅 Aujourd’hui ({{ date_obj.strftime("%d/%m/%Y") }})
            {% else %}
              ⏳ À venir dans {{ diff }} jour{% if diff > 1 %}s{% endif %} ({{ date_obj.strftime("%d/%m/%Y") }})
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}
{% endblock %}
