<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script defer src="{{ url_for('static', filename='js/clock.js') }}"></script>
  <style>
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
    @keyframes pulse {0%{transform:scale(1);}50%{transform:scale(1.08);}100%{transform:scale(1);}}

    #cnaps-alert, #stagiaires-alert, #vtc-alert, #contrats-alert, #factures-alert {
      margin:40px auto 0;
      max-width:600px;
      text-align:center;
      animation:fadeIn 0.6s ease-in;
    }

    .alert-box {
      background:linear-gradient(135deg, #2ecc71, #27ae60);
      color:white;
      font-weight:600;
      padding:18px 25px;
      border-radius:14px;
      font-size:18px;
      box-shadow:0 4px 10px rgba(0,0,0,0.15);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:background 0.3s ease;
    }

    .active .alert-box {animation:pulse 1.8s infinite;}
    .alert-box.ok {background:linear-gradient(135deg, #27ae60, #1e8449);}
    .alert-box.empty {background:linear-gradient(135deg, #95a5a6, #7f8c8d);}
    .alert-box.error {background:linear-gradient(135deg, #e74c3c, #c0392b);}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <img src="{{ url_for('static', filename='img/logo-integrale.png') }}" alt="Logo Intégrale Academy" class="logo">
      <div>
        <h1>Plateforme de gestion <span>Intégrale Academy</span></h1>
        <div id="clock" class="clock">—</div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Section interne -->
    <div class="grid">
      <a class="card" href="https://assistance-alw9.onrender.com/admin" target="_blank" rel="noopener">
        <div class="emoji">🛟</div>
        <div class="title">Assistance</div>
        <div class="desc">Accéder au centre d'aide</div>
      </a>

      <a class="card" href="https://cnapsv3.onrender.com/" target="_blank" rel="noopener">
        <div class="emoji">🛰️</div>
        <div class="title">Suivi demandes CNAPS</div>
        <div class="desc">Tableau de suivi</div>
      </a>

      <a class="card" href="https://cnapsv5-1.onrender.com/admin" target="_blank" rel="noopener">
        <div class="emoji">📤</div>
        <div class="title">Dépôt dossiers CNAPS</div>
        <div class="desc">Espace d'administration</div>
      </a>

      <a class="card" href="https://bts-wpfy.onrender.com/admin" target="_blank" rel="noopener">
        <div class="emoji">📝</div>
        <div class="title">Gestion contrats d'apprentissage</div>
        <div class="desc">Création & suivi</div>
      </a>

      <a class="card" href="https://vtc-qh20.onrender.com/admin" target="_blank" rel="noopener">
        <div class="emoji">🚖</div>
        <div class="title">Examens VTC</div>
        <div class="desc">Administration examens</div>
      </a>

      <a class="card" href="https://inscriptions-akou.onrender.com/admin" target="_blank" rel="noopener">
        <div class="emoji">🎓</div>
        <div class="title">Gestions des dossiers stagiaires</div>
        <div class="desc">Inscriptions & pièces</div>
      </a>

      <a class="card" href="https://factures-jx8r.onrender.com/login" target="_blank" rel="noopener">
        <div class="emoji">💶</div>
        <div class="title">Gestion des factures</div>
        <div class="desc">Portail de facturation</div>
      </a>

      <a class="card" href="{{ url_for('sessions_home') }}">
        <div class="emoji">📅</div>
        <div class="title">Gestion des sessions</div>
        <div class="desc">Paramétrage interne</div>
      </a>
    </div>

    <!-- Section externe -->
    <h2 class="section-title">Applications externes</h2>
    <div class="grid">
      <a class="card" href="https://integraleacademy.lightning.force.com/" target="_blank" rel="noopener">
        <div class="emoji">⚡</div>
        <div class="title">Salesforce</div>
        <div class="desc">CRM et gestion commerciale</div>
      </a>

      <a class="card" href="https://phone.onoffbusiness.com/calls" target="_blank" rel="noopener">
        <div class="emoji">📱</div>
        <div class="title">Onoff</div>
        <div class="desc">Téléphonie business</div>
      </a>

      <a class="card" href="https://calendly.com/" target="_blank" rel="noopener">
        <div class="emoji">📆</div>
        <div class="title">Calendly</div>
        <div class="desc">Planification de rendez-vous</div>
      </a>

      <a class="card" href="https://app.quicktalk.com/calls" target="_blank" rel="noopener">
        <div class="emoji">☎️</div>
        <div class="title">Quicktalk</div>
        <div class="desc">Standard téléphonique</div>
      </a>
    </div>

    <!-- 🔔 Suivi CNAPS -->
    <div id="cnaps-alert"><div id="cnaps-count" class="alert-box empty">📩 Chargement des demandes CNAPS...</div></div>

    <!-- 🎓 Suivi stagiaires -->
    <div id="stagiaires-alert"><div id="stagiaires-count" class="alert-box empty">🎓 Chargement des dossiers stagiaires...</div></div>

    <!-- 🚖 Suivi VTC -->
    <div id="vtc-alert"><div id="vtc-count" class="alert-box empty">🚖 Chargement des demandes examen VTC...</div></div>

    <!-- 📝 Suivi contrats apprentissage -->
    <div id="contrats-alert"><div id="contrats-count" class="alert-box empty">📝 Chargement des contrats d'apprentissage...</div></div>

    <!-- 💶 Suivi factures -->
    <div id="factures-alert"><div id="factures-count" class="alert-box empty">💶 Chargement des factures...</div></div>
  </main>

  <footer class="footer">© <span id="year"></span> Intégrale Academy — Tous droits réservés</footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    async function updateCnapsCount() {
      const box=document.getElementById("cnaps-count"), alert=document.getElementById("cnaps-alert");
      try{
        const r=await fetch("https://cnapsv5-1.onrender.com/data.json");
        if(!r.ok)throw 0;const d=await r.json();
        const c=(Array.isArray(d)?d:d.demandes||[]).filter(x=>!x.statut||x.statut.trim()==="").length;
        box.className="alert-box "+(c?"ok":"empty");alert.classList.toggle("active",c>0);
        box.innerHTML=c?`📩 <strong>${c}</strong> demande${c>1?"s":""} CNAPS en attente`:"✅ Aucune demande CNAPS en attente";
      }catch{box.className="alert-box error";box.innerHTML="🔒 Impossible de contacter la plateforme CNAPS";}
    }

    async function updateStagiairesCount() {
      const box=document.getElementById("stagiaires-count"), alert=document.getElementById("stagiaires-alert");
      try{
        const r=await fetch("https://inscriptions-akou.onrender.com/data.json");
        if(!r.ok)throw 0;const d=await r.json();
        const c=(Array.isArray(d)?d:d.dossiers||[]).filter(x=>!x.status||x.status.trim()===""||x.status==="INCOMPLET").length;
        box.className="alert-box "+(c?"ok":"empty");alert.classList.toggle("active",c>0);
        box.innerHTML=c?`🎓 <strong>${c}</strong> dossier${c>1?"s":""} stagiaire${c>1?"s":""} en attente`:"✅ Aucun dossier stagiaire en attente";
      }catch{box.className="alert-box error";box.innerHTML="🔒 Impossible de contacter la plateforme Inscriptions";}
    }

    async function updateVtcCount() {
      const box=document.getElementById("vtc-count"), alert=document.getElementById("vtc-alert");
      try{
        const r=await fetch("https://vtc-qh20.onrender.com/data.json");
        if(!r.ok)throw 0;const d=await r.json();
        const c=(Array.isArray(d)?d:[]).filter(x=>!x.statut||x.statut.trim().toUpperCase()==="A INSCRIRE A L'EXAMEN").length;
        box.className="alert-box "+(c?"ok":"empty");alert.classList.toggle("active",c>0);
        box.innerHTML=c?`🚖 <strong>${c}</strong> nouvelle${c>1?"s":""} demande${c>1?"s":""} examen VTC`:"✅ Aucun dossier VTC en attente";
      }catch{box.className="alert-box error";box.innerHTML="🔒 Impossible de contacter la plateforme VTC";}
    }

    async function updateContratsCount() {
      const box=document.getElementById("contrats-count"), alert=document.getElementById("contrats-alert");
      try{
        const r=await fetch("https://bts-wpfy.onrender.com/data.json");
        if(!r.ok)throw 0;const d=await r.json();
        const s=d.summary||{};
        const total=s.a_traiter+s.signature_en_cours+s.saisi_entreprise;
        box.className="alert-box "+(total?"ok":"empty");alert.classList.toggle("active",total>0);
        box.innerHTML=total?`📝 <strong>${s.a_traiter}</strong> à traiter, <strong>${s.signature_en_cours}</strong> en signature, <strong>${s.saisi_entreprise}</strong> en saisie entreprise`:"✅ Aucun contrat en attente";
      }catch{box.className="alert-box error";box.innerHTML="🔒 Impossible de contacter la plateforme Contrats";}
    }

    async function updateFacturesCount() {
      const box=document.getElementById("factures-count"), alert=document.getElementById("factures-alert");
      try{
        const r=await fetch("https://factures-jx8r.onrender.com/data.json");
        if(!r.ok)throw 0;const d=await r.json();
        const c=d.count||0;
        box.className="alert-box "+(c?"ok":"empty");alert.classList.toggle("active",c>0);
        box.innerHTML=c?`💶 <strong>${c}</strong> facture${c>1?"s":""} à régler`:"✅ Aucune facture en attente";
      }catch{box.className="alert-box error";box.innerHTML="🔒 Impossible de contacter la plateforme Factures";}
    }

    updateCnapsCount();updateStagiairesCount();updateVtcCount();updateContratsCount();updateFacturesCount();
    setInterval(updateCnapsCount,15000);
    setInterval(updateStagiairesCount,15000);
    setInterval(updateVtcCount,15000);
    setInterval(updateContratsCount,15000);
    setInterval(updateFacturesCount,15000);
  </script>
</body>
</html>
