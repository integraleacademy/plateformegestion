<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ title }}</title>

  <!-- âœ… Feuille de style principale -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script defer src="{{ url_for('static', filename='js/clock.js') }}"></script>

  <style>
    @keyframes pulse {0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);} }

    .notif {
      margin-top: 8px;
      font-size: 14px;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: 10px;
      text-align: center;
      transition: all 0.3s ease;
    }

    /* âœ… Carte CNAPS Ã©largie sur 3 colonnes */
.recent-acceptes.card{
  grid-column: 2 / span 3;  /* dÃ©marre en colonne 2, occupe 3 colonnes */
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

    .grid { align-items: stretch; }   /* force les lignes Ã  s'aligner */
.card { height: 100%; }           /* chaque carte remplit sa cellule */



.app-logo {
  width: 70px;                /* un peu plus large */
  height: 70px;
  object-fit: contain;
  display: block;
  margin: 10px auto 12px;
  transition: transform 0.2s ease;
  padding: 6px;               /* Ã©quilibre visuel */
  background: #fff;           /* fond neutre */
  border-radius: 12px;        /* coins doux */
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.card:hover .app-logo {
  transform: scale(1.08);
}



    .notif.ok {background: rgba(39, 174, 96, 0.1); color: #1e8449;}
    .notif.wait {background: rgba(241, 196, 15, 0.15); color: #b9770e; animation: pulse 2s infinite;}
    .notif.error {background: rgba(231, 76, 60, 0.15); color: #c0392b;}
    .notif.alert {background: rgba(231, 76, 60, 0.1); color: #c0392b; font-weight: 700; animation: pulse 1.5s infinite;}
    .notif.empty {background: rgba(149,165,166,0.15); color:#7f8c8d;}

    /* âœ… EncadrÃ© dossiers acceptÃ©s */
    .recent-acceptes {
      background: #fff;
      border-radius: 12px;
      padding: 14px 18px;
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
      border: 1px solid rgba(0,0,0,.06);
      
    }
    .recent-acceptes h3 {
      margin: 0 0 8px;
      color: #1e8449;
      font-size: 16px;
      font-weight: 700;
    }
    .recent-acceptes ul {
      list-style: none;
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }
    .recent-acceptes li::before {
      content: "â€¢ ";
      color: #27ae60;
      font-weight: bold;
    }
    .recent-acceptes.none {
      opacity: .8;
      color: #555;
    }

    @media (max-width: 1200px){
  .recent-acceptes.card{ grid-column: 1 / -1; }
}




  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <img src="{{ url_for('static', filename='img/logo-integrale.png') }}" alt="Logo IntÃ©grale Academy" class="logo">
      <div>
        <h1>Plateforme de gestion <span>IntÃ©grale Academy</span></h1>
        <div id="clock" class="clock">â€”</div>
      </div>
    </div>
  </header>

  <main class="container">



<div class="grid">
  <a class="card" href="https://assistance-alw9.onrender.com/admin" target="_blank" rel="noopener">
    <div class="emoji">ğŸ›Ÿ</div>
    <div class="title">Assistance</div>
    <div class="desc">Gestion des tickets</div>
    <div id="notif-assistance" class="notif empty">ğŸ›Ÿ Chargement...</div>
  </a>

  <a class="card" href="https://cnapsv5-1.onrender.com/admin" target="_blank" rel="noopener">
    <div class="emoji">ğŸ“¤</div>
    <div class="title">DÃ©pÃ´t dossiers CNAPS</div>
    <div class="desc">Demandes CNAPS Ã  traiter</div>
    <div id="notif-cnaps" class="notif empty">ğŸ“© Chargement...</div>
  </a>

  <a class="card" href="https://cnapsv3.onrender.com/" target="_blank" rel="noopener">
    <div class="emoji">ğŸ‘®â€â™‚ï¸</div>
    <div class="title">Suivi des demandes CNAPS</div>
    <div class="desc">Instruction des dossiers</div>
    <div id="notif-suivi" class="notif empty">ğŸ‘®â€â™‚ï¸ Chargement...</div>
  </a>

  <a class="card" href="https://inscriptions-akou.onrender.com/admin" target="_blank" rel="noopener">
    <div class="emoji">ğŸ“</div>
    <div class="title">Gestion des dossiers stagiaires</div>
    <div class="desc">Inscriptions & piÃ¨ces justificatives </div>
    <div id="notif-stagiaires" class="notif empty">ğŸ“ Chargement...</div>
  </a>

  <a class="card" href="https://inscriptionsbts.onrender.com/admin" target="_blank" rel="noopener">
  <div class="emoji">ğŸ«</div>
  <div class="title">Gestion des inscriptions BTS</div>
  <div class="desc">PrÃ©-inscriptions Ã  traiter</div>
  <div id="notif-bts" class="notif empty">ğŸ« Chargement...</div>
</a>

  <a class="card" href="https://vtc-qh20.onrender.com/admin" target="_blank" rel="noopener">
    <div class="emoji">ğŸš–</div>
    <div class="title">Examens VTC</div>
    <div class="desc">Inscriptions Ã  l'examen</div>
    <div id="notif-vtc" class="notif empty">ğŸš– Chargement...</div>
  </a>

  <a class="card" href="https://bts-wpfy.onrender.com/admin" target="_blank" rel="noopener">
    <div class="emoji">ğŸ“</div>
    <div class="title">Contrats d'apprentissage</div>
    <div class="desc">Suivi des dossiers</div>
    <div id="notif-contrats" class="notif empty">ğŸ“ Chargement...</div>
  </a>

  <a class="card" href="https://factures-jx8r.onrender.com/login" target="_blank" rel="noopener">
    <div class="emoji">ğŸ’¼</div>
    <div class="title">Gestion des factures</div>
    <div class="desc">Portail de facturation</div>
    <div id="notif-factures" class="notif empty">ğŸ’¼ Chargement...</div>
  </a>

  <a class="card" href="{{ url_for('dotations_home') }}">
    <div class="emoji">ğŸ</div>
    <div class="title">Gestion des dotations</div>
    <div class="desc">iPad & badge cafÃ©</div>
    <div id="notif-dotations" class="notif empty">ğŸ Chargement...</div>
  </a>

   <a class="card" href="{{ url_for('sessions_home') }}">
    <div class="emoji">ğŸ“…</div>
    <div class="title">Gestion des sessions</div>
    <div class="desc">Suivi des Ã©chÃ©ances</div>
    <div id="notif-sessions" class="notif empty">ğŸ“… Chargement...</div>
  </a>

    <a class="card" href="{{ url_for('formateurs_home') }}">
    <div class="emoji">ğŸ‘¨â€ğŸ«</div>
    <div class="title">ContrÃ´le formateurs</div>
    <div class="desc">Dossiers & conformitÃ©</div>
    <div class="notif 
  {% if formateurs_non_conformes == 0 %}ok{% else %}alert{% endif %}
">
  {% if formateurs_non_conformes == 0 %}
    âœ… Tous les formateurs sont conformes
  {% else %}
    âš ï¸ {{ formateurs_non_conformes }} non-conformitÃ©{{ "s" if formateurs_non_conformes>1 }} dÃ©tectÃ©e{{ "s" if formateurs_non_conformes>1 }}
  {% endif %}
</div>

  </a>


  <a class="card" href="https://assistance-alw9.onrender.com/admin_hebergement" target="_blank" rel="noopener">
  <div class="emoji">ğŸ›ï¸</div>
  <div class="title">Gestion hÃ©bergement</div>
  <div class="desc">RÃ©servations & paiements</div>
  <div id="notif-hebergement" class="notif empty">ğŸ›ï¸ Chargement...</div>
</a>


  <!-- âœ… Bloc CNAPS acceptÃ©s intÃ©grÃ© Ã  cÃ´tÃ© -->
  <div class="card recent-acceptes" id="recent-acceptes">

    <h3>âœ… Derniers dossiers CNAPS acceptÃ©s </h3>
    <div id="liste-acceptes">Chargement...</div>
  </div>
</div> <!-- â† fermeture de la grille -->



<h2 class="section-title">Applications externes</h2>
<div class="grid">
  <a class="card" href="https://integraleacademy.lightning.force.com/" target="_blank" rel="noopener">
    <img src="{{ url_for('static', filename='img/salesforce.png') }}" alt="Salesforce" class="app-logo">
    <div class="title">Salesforce</div>
    <div class="desc">CRM et gestion commerciale</div>
  </a>

  <a class="card" href="https://phone.onoffbusiness.com/calls" target="_blank" rel="noopener">
    <img src="{{ url_for('static', filename='img/onoff.png') }}" alt="Onoff" class="app-logo">
    <div class="title">Onoff</div>
    <div class="desc">TÃ©lÃ©phonie business</div>
  </a>

  <a class="card" href="https://calendly.com/" target="_blank" rel="noopener">
    <img src="{{ url_for('static', filename='img/calendly.png') }}" alt="Calendly" class="app-logo">
    <div class="title">Calendly</div>
    <div class="desc">Planification de rendez-vous</div>
  </a>

  <a class="card" href="https://app.quicktalk.com/calls" target="_blank" rel="noopener">
    <img src="{{ url_for('static', filename='img/quicktalk.png') }}" alt="Quicktalk" class="app-logo">
    <div class="title">Quicktalk</div>
    <div class="desc">Standard tÃ©lÃ©phonique</div>
  </a>
</div>

  </main>

  <footer class="footer">Â© <span id="year"></span> IntÃ©grale Academy â€” Tous droits rÃ©servÃ©s</footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // âœ… Bloc CNAPS AcceptÃ©s (7 jours)
    async function updateRecentAcceptes() {
      const box = document.getElementById("liste-acceptes");
      try {
        const r = await fetch("https://cnapsv3.onrender.com/recent_acceptes.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const list = d.recent_acceptes || [];
        if (list.length === 0) {
          box.innerHTML = "<em>Aucun dossier acceptÃ© ces 7 derniers jours.</em>";
        } else {
          box.innerHTML = "<ul>" + list.map(x =>
  `<li><strong>${x.nom}</strong> ${x.prenom}${x.session ? " â€” <em>" + x.session + "</em>" : ""}</li>`
).join("") + "</ul>";
        }
      } catch {
        box.innerHTML = "<span style='color:#c0392b'>Erreur de chargement</span>";
      }
    }

    // --- Assistance ---
    async function updateAssistance() {
      const box = document.getElementById("notif-assistance");
      try {
        const r = await fetch("https://assistance-alw9.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const c = d.a_traiter || 0;
        if (c > 0) {
          box.className = "notif wait";
          box.innerHTML = `ğŸ›Ÿ ${c} demande${c>1?"s":""} assistance Ã  traiter`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "âœ… Aucune demande assistance en attente";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "ğŸ”’ Erreur Assistance";
      }
    }

        // --- DOTATIONS ---
    // --- DOTATIONS ---
async function updateDotations() {
  const box = document.getElementById("notif-dotations");
  try {
    const r = await fetch("https://plateformegestion.onrender.com/dotations_data.json");
    if (!r.ok) throw 0;
    const d = await r.json();

    const a = d.a_distribuer || 0;
    const nr = d.non_restituees || 0;
    const rstu = d.restituees || 0;

    let message = `ğŸ ${a} Ã  distribuer, ${nr} non restituÃ©e${nr>1?'s':''}, ${rstu} restituÃ©e${rstu>1?'s':''}`;

    if (nr > 0) {
      box.className = "notif alert"; // ğŸ”´ rouge (urgences)
    } else if (a > 0) {
      box.className = "notif wait"; // ğŸŸ  orange (Ã  distribuer)
    } else {
      box.className = "notif ok"; // ğŸŸ¢ vert (tout rendu)
      message = "âœ… Tout est OK";
    }

    box.innerHTML = message;

  } catch {
    box.className = "notif error";
    box.innerHTML = "ğŸ”’ Erreur Dotations";
  }
}



    // --- CNAPS DÃ©pÃ´t ---
    async function updateCnaps() {
      const box = document.getElementById("notif-cnaps");
      try {
        const r = await fetch("https://cnapsv5-1.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const demandes = Array.isArray(d) ? d : d.demandes || [];
        const total = demandes.length;
        if (total > 0) {
          box.className = "notif wait";
          box.innerHTML = `ğŸ“© ${total} demande${total>1?"s":""} CNAPS en attente`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "âœ… Aucune demande CNAPS en attente";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "ğŸ”’ Erreur CNAPS";
      }
    }

    // --- CNAPS Suivi ---
    async function updateSuivi() {
      const box = document.getElementById("notif-suivi");
      try {
        const r = await fetch("https://cnapsv3.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const c = d.instruction || 0;
        if (c > 0) {
          box.className = "notif wait";
          box.innerHTML = `ğŸ‘®â€â™‚ï¸ ${c} dossier${c>1?"s":""} instruction en cours`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "âœ… Aucun dossier en instruction";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "ğŸ”’ Erreur Suivi CNAPS";
      }
    }

    // --- STAGIAIRES ---
    async function updateStagiaires() {
      const box = document.getElementById("notif-stagiaires");
      try {
        const r = await fetch("https://inscriptions-akou.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const c = (Array.isArray(d)?d:d.dossiers||[]).filter(x=>!x.status||x.status.trim()===""||x.status==="INCOMPLET").length;
        if (c > 0) {
          box.className = "notif wait";
          box.innerHTML = `ğŸ“ ${c} dossier${c>1?"s":""} stagiaire${c>1?"s":""} Ã  traiter`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "âœ… Aucun dossier stagiaire en attente";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "ğŸ”’ Erreur Inscriptions";
      }
    }

    // --- INSCRIPTIONS BTS ---
async function updateBTS() {
  const box = document.getElementById("notif-bts");
  try {
    const r = await fetch("https://inscriptionsbts.onrender.com/data.json");
    if (!r.ok) throw 0;
    const d = await r.json();

    // ğŸ‘‰ selon le format de ton data.json cÃ´tÃ© site BTS
    const a_traiter = d.a_traiter || d.en_attente || 0;

    if (a_traiter > 0) {
      box.className = "notif wait";
      box.innerHTML = `ğŸ« ${a_traiter} prÃ©-inscription${a_traiter>1?"s":""} Ã  traiter`;
    } else {
      box.className = "notif ok";
      box.innerHTML = "âœ… Aucune prÃ©-inscription en attente";
    }
  } catch {
    box.className = "notif error";
    box.innerHTML = "ğŸ”’ Erreur Inscriptions BTS";
  }
}


    // --- VTC ---
async function updateVtc() {
  const box = document.getElementById("notif-vtc");

  try {
    const r = await fetch("https://vtc-qh20.onrender.com/summary.json");
    if (!r.ok) throw 0;

    const d = await r.json();

    const a = d.a_inscrire || 0;
    const l = d.livres_a_envoyer || 0;

    let texte = "";

    if (a === 0 && l === 0) {
      box.className = "notif ok";
      box.innerHTML = "ğŸš– Tout est OK";
      return;
    }

    // au moins un des deux compteurs est > 0
    box.className = "notif wait";

    if (a > 0) {
      texte += `ğŸš– ${a} dossier${a>1?"s":""} Ã  inscrire`;
    }

    if (l > 0) {
      if (texte !== "") texte += " â€” ";
      texte += `ğŸ“• ${l} livre${l>1?"s":""} Ã  envoyer`;
    }

    box.innerHTML = texte;

  } catch {
    box.className = "notif error";
    box.innerHTML = "ğŸ”’ Erreur VTC";
  }
}


    // --- CONTRATS ---
    async function updateContrats() {
      const box = document.getElementById("notif-contrats");
      try {
        const r = await fetch("https://bts-wpfy.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const s = d.summary || {};
        const total = (s.a_traiter||0)+(s.signature_en_cours||0)+(s.saisi_entreprise||0);
        if (total > 0) {
          box.className = "notif wait";
          box.innerHTML = `ğŸ“ ${s.a_traiter||0} Ã  traiter, ${s.signature_en_cours||0} en signature, ${s.saisi_entreprise||0} en saisie`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "âœ… Aucun contrat en attente";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "ğŸ”’ Erreur Contrats";
      }
    }

    // --- FACTURES ---
    async function updateFactures() {
      const box = document.getElementById("notif-factures");
      try {
        const r = await fetch("https://factures-jx8r.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const c = d.count || 0;
        if (c > 0) {
          box.className = "notif wait";
          box.innerHTML = `ğŸ’¼ ${c} facture${c>1?"s":""} Ã  rÃ©gler`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "âœ… Aucune facture en attente";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "ğŸ”’ Erreur Factures";
      }
    }

    // --- SESSIONS ---
    async function updateSessions() {
      const box = document.getElementById("notif-sessions");
      try {
        const r = await fetch("https://plateformegestion.onrender.com/data.json");
        if (!r.ok) throw 0;
        const d = await r.json();
        const retards = d.retards || 0;
        if (retards > 0) {
          box.className = "notif alert";
          box.innerHTML = `âš ï¸ ${retards} Ã©tape${retards>1?"s":""} en retard`;
        } else {
          box.className = "notif ok";
          box.innerHTML = "âœ… Dans les temps";
        }
      } catch {
        box.className = "notif error";
        box.innerHTML = "ğŸ”’ Erreur Sessions";
      }
    }

// --- HÃ‰BERGEMENT ---
async function updateHebergement() {
  const box = document.getElementById("notif-hebergement");

  try {
    const r = await fetch("https://assistance-alw9.onrender.com/hebergement_data.json");
    if (!r.ok) throw 0;

    const d = await r.json();

    const total = d.total || 0;
    const payes = d.payes || 0;
    const non_payes = d.non_payes || 0;

    // ğŸŸ¢ Aucun hÃ©bergement
    if (total === 0) {
      box.className = "notif ok";
      box.innerHTML = "âœ… Aucune rÃ©servation";
      return;
    }

    // ğŸ”´ Si il y a au moins 1 non payÃ©
    if (non_payes > 0) {
      box.className = "notif alert";
      box.innerHTML =
        `ğŸ›ï¸ ${non_payes} non payÃ©e${non_payes>1?"s":""} â€” ${payes} payÃ©e${payes>1?"s":""}`;
      return;
    }

    // ğŸŸ¢ Tout est payÃ©
    box.className = "notif ok";
    box.innerHTML =
      `ğŸ›ï¸ ${payes} payÃ©e${payes>1?"s":""} â€” 0 non payÃ©e`;

  } catch {
    box.className = "notif error";
    box.innerHTML = "ğŸ”’ Erreur hÃ©bergement";
  }
}




    // --- RafraÃ®chissements ---
    function refreshAll() {
  updateAssistance();
  updateCnaps();
  updateSuivi();
  updateStagiaires();
  updateVtc();
  updateContrats();
  updateFactures();
  updateSessions();
  updateDotations();
  updateBTS(); 
  updateHebergement();
}


    updateRecentAcceptes();
    setInterval(updateRecentAcceptes, 15000);

    refreshAll();
    setInterval(refreshAll, 15000);
  </script>

  <script>
/* === Recharge automatique dâ€™une ligne aprÃ¨s sauvegarde === */
function reloadRow(fid, docId, rowElem) {
  fetch(`/formateurs/${fid}`)
    .then(r => r.text())
    .then(html => {
      // On crÃ©e un DOM temporaire
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      // On retrouve dans le HTML rechargÃ© la ligne du mÃªme document
      const newRow = doc.querySelector(`tr[data-doc-id="${docId}"]`);
      if (!newRow) return;

      // On remplace la ligne actuelle par la nouvelle (actualisÃ©e)
      rowElem.innerHTML = newRow.innerHTML;

      // On relance les listeners (expiration, statut, commentaire, fichiers)
      attachListenersToRow(rowElem);
    });
}

/* === RÃ©attacher les Ã©vÃ©nements aprÃ¨s mise Ã  jour === */
function attachListenersToRow(row) {
  const expiration = row.querySelector("input[name='expiration']");
  const statusSel  = row.querySelector("select[name='status']");
  const comment    = row.querySelector("textarea[name='commentaire']");
  const fileInput  = row.querySelector("input[name='piece_jointe']");
  const fid        = document.getElementById("formateur-detail").dataset.fid;
  const docId      = row.dataset.docId;

  function update() {
    // On rappelle la fonction sendUpdate dÃ©jÃ  existante
    sendUpdate(row);

    // Puis on recharge la ligne avec les donnÃ©es mises Ã  jour
    setTimeout(() => reloadRow(fid, docId, row), 200);
  }

  if (expiration) expiration.addEventListener("change", update);
  if (statusSel)  statusSel.addEventListener("change", update);
  if (comment)    comment.addEventListener("blur", update);
  if (fileInput)  fileInput.addEventListener("change", update);
}

/* === Activer automatiquement sur toutes les lignes existantes === */
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("tr[data-doc-id]").forEach(row => {
    attachListenersToRow(row);
  });
});
</script>

  <script>
  // RafraÃ®chit automatiquement la page toutes les 10 minutes
  // 10 min = 10 * 60 * 1000 = 600 000 ms
  setInterval(() => {
    console.log("âŸ³ RafraÃ®chissement automatique (toutes les 10 minutes)...");
    window.location.reload();
  }, 600000);
</script>


  

  
</body>
</html>
