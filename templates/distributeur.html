{% extends "nav.html" %}

{% block content %}
<div style="max-width:1100px;margin:25px auto;">
  <h1 style="margin-top:0;margin-bottom:15px;">‚òïÔ∏è Gestion du distributeur</h1>
  <p style="color:#555;margin-bottom:20px;">
    Chaque ligne repr√©sente un √©tage du distributeur. Chaque case correspond √† un produit (boisson, snack, etc.).
  </p>

  <div class="machine-wrapper">
    <div class="machine">
      {% for ligne in data.lignes %}
        <div class="machine-row">
          <div class="row-label">
            √âtage {{ ligne.id }}
          </div>

          <div class="row-slots">

            {% for p in ligne.produits if p.nom %}
              <div class="slot">

                {% if request.args.get('edit') == p.id %}
                <!-- MODE √âDITION -->
                <form method="POST" action="/distributeur/update/{{ ligne.id }}/{{ p.id }}">
                  
                  <div class="slot-line">
                    <label>Nom :</label>
                    <input name="nom" value="{{ p.nom }}" required>
                  </div>

                  <div class="slot-line">
                    <label>Qt√© th√©orique :</label>
                    <input type="number" name="qte_cible" value="{{ p.qte_cible }}" min="0" required>
                  </div>

                  <div class="slot-line">
                    <label>Qt√© actuelle :</label>
                    <input type="number" name="qte_actuelle" value="{{ p.qte_actuelle }}" min="0" required>
                  </div>

                  <div class="slot-line">
                    <label>Prix d'achat :</label>
                    <input type="number" step="0.01" name="prix_achat" value="{{ p.prix_achat }}" min="0" required>
                  </div>

                  <div class="slot-line">
                    <label>Prix de vente :</label>
                    <input type="number" step="0.01" name="prix_vente" value="{{ p.prix_vente }}" min="0" required>
                  </div>

                  <button class="btn-small" style="background:#10b981;color:white;margin-top:6px;">
                    üíæ Enregistrer
                  </button>
                </form>

                {% else %}
                <!-- MODE AFFICHAGE -->
                <div class="slot-header">
                  <span class="slot-name">{{ p.nom }}</span>
                  <span class="slot-code">L{{ ligne.id }}-{{ loop.index }}</span>
                </div>

                <div class="slot-body">
                  <div class="slot-line">
                    <span class="label">Qt√© th√©orique :</span>
                    <span>{{ p.qte_cible }}</span>
                  </div>

                  <div class="slot-line">
                    <span class="label">Qt√© actuelle :</span>
                    <span>{{ p.qte_actuelle }}</span>
                  </div>

                  <div class="slot-line">
                    <span class="label">R√©assort :</span>
                    <span>{{ p.qte_cible - p.qte_actuelle if p.qte_cible - p.qte_actuelle > 0 else 0 }}</span>
                  </div>

                  <div class="slot-line">
                    <span class="label">Prix d'achat :</span>
                    <span>{{ "%.2f"|format(p.prix_achat) }} ‚Ç¨</span>
                  </div>

                  <div class="slot-line">
                    <span class="label">Prix de vente :</span>
                    <span>{{ "%.2f"|format(p.prix_vente) }} ‚Ç¨</span>
                  </div>

                  {% set marge = p.prix_vente - p.prix_achat %}
                  {% set marge_ok = p.prix_vente >= 2 * p.prix_achat %}

                  <div class="slot-line {% if not marge_ok %}bad-margin{% endif %}">
                    <span class="label">Marge :</span>
                    <span>{{ "%.2f"|format(marge) }} ‚Ç¨
                      {% if not marge_ok %}
                        <span class="alert-margin">‚ö†Ô∏è Marge &lt; x2</span>
                      {% endif %}
                    </span>
                  </div>
                </div>

<div class="slot-footer">
  <a href="?edit={{ p.id }}" class="btn-small btn-edit" style="cursor:pointer;opacity:1;">
    ‚úèÔ∏è Modifier
  </a>

  <form method="POST" action="/distributeur/delete/{{ ligne.id }}/{{ p.id }}" 
        onsubmit="return confirm('Supprimer ce produit ?')" 
        style="margin:0;">
    <button class="btn-small btn-delete" style="background:#fee2e2;color:#b91c1c;opacity:1;cursor:pointer;">
      üóë Supprimer
    </button>
  </form>
</div>


                {% endif %}
              </div>
            {% endfor %}

            <!-- Bouton AJOUT -->
            <div class="slot slot-add">
              <form method="POST" action="/distributeur/add/{{ ligne.id }}" style="margin:0;">
                <button type="submit" class="slot-add-inner" style="background:none;border:none;color:inherit;cursor:pointer;">
                  <div class="plus-icon">Ôºã</div>
                  <div>Ajouter un produit<br><small>Ligne {{ ligne.id }}</small></div>
                </button>
              </form>
            </div>

          </div>
        </div>
      {% endfor %}
    </div>
  </div>

</div>

<style>
  .machine-wrapper{
    background:#f3f4f6;
    padding:18px;
    border-radius:16px;
    box-shadow:0 8px 24px rgba(0,0,0,0.06);
  }
  .machine{
    background:#1f2933;
    padding:18px;
    border-radius:16px;
    border:3px solid #111827;
  }
  .machine-row{
    display:flex;
    align-items:flex-start;
    gap:12px;
    margin-bottom:14px;
  }
  .row-label{
    width:90px;
    padding:10px 8px;
    border-radius:10px;
    background:#111827;
    color:#f9fafb;
    font-weight:600;
    font-size:14px;
    text-align:center;
  }
  .row-slots{
    flex:1;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .slot{
    background:#f9fafb;
    border-radius:12px;
    padding:10px 10px 8px;
    min-width:160px;
    max-width:190px;
    flex:0 0 auto;
    box-shadow:0 4px 10px rgba(0,0,0,0.12);
    border:1px solid #e5e7eb;
  }
  .slot-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:6px;
    font-size:13px;
    font-weight:600;
  }
  .slot-name{
    max-width:120px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .slot-code{
    font-size:11px;
    padding:2px 6px;
    border-radius:999px;
    background:#e5e7eb;
    color:#111827;
  }
  .slot-body{
    font-size:12px;
  }
  .slot-line{
    display:flex;
    justify-content:space-between;
    margin:2px 0;
  }
  .slot-line .label{
    color:#6b7280;
    margin-right:6px;
  }
  .slot-line.bad-margin{
    color:#b91c1c;
    font-weight:600;
  }
  .alert-margin{
    font-size:11px;
    margin-left:4px;
  }
  .slot-footer{
    margin-top:6px;
    display:flex;
    justify-content:flex-end;
    gap:6px;
  }
  .btn-small{
    font-size:11px;
    padding:3px 6px;
    border-radius:6px;
    border:none;
  }
  .btn-edit{
    background:#e5e7eb;
  }

  .slot-add{
    background:rgba(31,41,55,0.8);
    border:1px dashed #9ca3af;
    color:#e5e7eb;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .slot-add-inner{
    text-align:center;
    font-size:13px;
    line-height:1.3;
  }
  .slot-add-inner small{
    font-size:11px;
    opacity:0.8;
  }
  .plus-icon{
    font-size:22px;
    line-height:1;
    margin-bottom:4px;
  }
</style>
{% endblock %}

