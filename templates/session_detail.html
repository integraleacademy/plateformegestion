<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

  <style>
    .filter-bar {
      display:flex; flex-wrap:wrap; gap:10px; margin-bottom:25px;
      background:#fff; border-radius:10px; padding:10px 15px;
      box-shadow:0 2px 6px rgba(0,0,0,.1); align-items:center;
    }
    .filter-bar select,.filter-bar input {
      padding:8px 10px; border:1px solid #ccc;
      border-radius:6px; font-size:14px;
    }
    .filter-bar input { flex:1; }

    .section-title {
      margin-top:35px;
      font-size:22px;
      font-weight:700;
      color:#F4C45A;
      display:block;
    }
    .section-line {
      width:100%;
      height:2px;
      background:#F4C45A;
      margin:4px 0 18px 0;
      border-radius:5px;
      opacity:0.8;
    }

    .hidden { display:none!important; }
    .step { margin-bottom:18px; transition:all .25s; }

    /* SOMMAIRE SSIAP */
    .sommaire-ssi {
      background:#fff;
      padding:15px 20px;
      border-radius:12px;
      box-shadow:0 3px 10px rgba(0,0,0,0.08);
      margin-bottom:28px;
      position:sticky;
      top:65px;
      z-index:99;
    }
    .sommaire-list {
      display:flex;
      flex-wrap:wrap;
      gap:12px 18px;
    }
    .sommaire-item {
      background:#f4f4f4;
      padding:7px 12px;
      border-radius:8px;
      text-decoration:none;
      color:#333;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
      transition:0.2s;
    }
    .sommaire-item:hover {
      background:#f4c45a;
      color:#000;
    }

    .toggle-all-btn {
      background:#f4c45a;
      border:none;
      padding:8px 14px;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      margin-bottom:20px;
      transition:.2s;
    }
    .toggle-all-btn:hover { background:#d9a848; }
  </style>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <a href="{{ url_for('sessions_home') }}" class="back">‚Üê Retour</a>
    <img src="{{ url_for('static', filename='img/logo-integrale.png') }}" class="logo">
    <div>
      <h1>{{ s.formation }} ‚Äî Fiche session</h1>
      <div class="clock small">
        Du {{ s.date_debut|datefr if s.date_debut else '‚Äî' }}
        au {{ s.date_fin|datefr if s.date_fin else '‚Äî' }} ‚Ä¢
        Examen : {{ s.date_exam|datefr if s.date_exam else '‚Äî' }}
      </div>
    </div>
  </div>
</header>

<main class="container">

<!-- ======================================================================= -->
<!--                            ACTIONS (boutons)                            -->
<!-- ======================================================================= -->

<div class="actions-bar">
  <form method="get" action="{{ url_for('edit_session', sid=s.id) }}">
    <button type="submit" class="btn edit">‚úèÔ∏è Modifier la session</button>
  </form>
  <form method="post" action="{{ url_for('delete_session', sid=s.id) }}" onsubmit="return confirm('Supprimer ?');">
    <button type="submit" class="btn danger">üóëÔ∏è Supprimer la session</button>
  </form>
</div>

{% if not s.steps %}
<p class="muted">Aucune √©tape d√©finie pour {{ s.formation }}.</p>
{% else %}

<!-- ======================================================================= -->
<!--                   TRI PAR DEADLINE POUR TOUS LES MODES                  -->
<!-- ======================================================================= -->

{% set steps_with_deadlines = [] %}
{% for i in range(s.steps|length) %}
  {% set st = statuses[i] %}
  {% set step = s.steps[i] %}
  {% set deadline = st.deadline | datetime if st.deadline else None %}
  {% set _ = steps_with_deadlines.append({'index': i, 'step': step, 'st': st, 'deadline': deadline}) %}
{% endfor %}
{% set sorted_steps = steps_with_deadlines|sort(attribute='deadline') %}

<!-- ======================================================================= -->
<!--                              MODE SSIAP                                 -->
<!-- ======================================================================= -->

{% if s.formation == 'SSIAP' %}

<button id="toggleAllBtn" class="toggle-all-btn">‚ÜïÔ∏è Replier / D√©plier tout</button>

{% set sections = {
  "üî• Session" : [
    "Le formateur a √©t√© nomm√© (65 jours avant d√©but de session)",
    "Le contrat d'intervention a √©t√© envoy√© au formateur (7 jours avant d√©but de session)",
    "Le contrat d'intervention formateur a √©t√© sign√© et imprim√© (5 jours avant d√©but de session)",
    "Le nombre de candidats est de 12 maximum (2 jours avant d√©but de session)",
    "La pr√©fecture a √©t√© avis√©e de l'ouverture de la session 2 mois avant le d√©marrage (65 jours avant d√©but de session)",
    "La pr√©fecture a √©t√© avis√©e de la date d'examen 2 mois avant le d√©marrage (65 jours avant d√©but de session)",
    "Les convocations en formation ont √©t√© envoy√©es aux candidats (15 jours avant d√©but de session)",
    "Le test de fran√ßais a √©t√© envoy√© √† tous les candidats (7 jours avant d√©but de session)"
  ],
  "üìÅ Dossier candidat (formation)" : [
    "Le dossier comporte la pi√®ce d'identit√© de chaque candidat (1er jour de formation)",
    "Le dossier comporte l'attestation de formation au secourisme de chaque candidat (1er jour de formation)",
    "Le dossier comporte 2 photos d'identit√© (1 archive, 1 dipl√¥me) pour chaque candidat (1er jour de formation)",
    "Le dossier comporte le certificat m√©dical conforme √† l'Annexe VII de l'arr√™t√© du 2 mai 2005 modifi√© de chaque candidat (1er jour de formation)",
    "Le dossier comporte une copie du test de fran√ßais r√©alis√© par chaque candidat en amont de la formation (1er jour de formation)",
    "Le dossier comporte le contrat de formation sign√© par chaque candidat (1er jour de formation)",
    "Les dossiers de chaque candidat ont √©t√© v√©rifi√©s avant le d√©marrage de la session (1er jour de formation)"
  ],
  "üèõÔ∏è Demande pr√©sidence de jury SDIS" : [
    "Le SDIS a √©t√© avis√© de la date d'organisation des √©preuves (65 jours avant d√©but de session)",
    "La demande comporte le nom, la fonction et la qualification du jury chef de service incendie (65 jours avant d√©but de session)",
    "La demande comporte l'attestation d'engagement (accord) du jury chef de service incendie (65 jours avant d√©but de session)",
    "L'engagement √©crit, du propri√©taire ou de l'exploitant de l'√©tablissement, de mettre √† disposition les locaux et d'autoriser la manipulation des installations techniques n√©cessaires au d√©roulement de l'√©preuve pratique est fournit (65 jours avant d√©but de session)",
    "Le planning de la session est fournit (65 jours avant d√©but de session)",
    "Sur le planning le nom, la qualit√©, la fonction et les qualifications des formateurs sont indiqu√©s (65 jours avant d√©but de session)",
    "La convention de demande pr√©sidence SDIS fournie en double exemplaire (65 jours avant d√©but de session)",
    "La demande de pr√©sidence SDIS a √©t√© envoy√©e en LRAR (65 jours avant d√©but de session)"
  ],
  "üßæ Dossier candidat (examen)" : [
    "Les dossiers examen des candidats sont imprim√©s (2 jours avant l'examen)",
    "Chaque dossier examen comporte la pi√®ce d'identit√© du candidat (2 jours avant l'examen)",
    "Chaque dossier examen comporte l'attestation de formation au secourisme (2 jours avant l'examen)",
    "Chaque dossier examen comporte le certificat m√©dical conforme √† l'Annexe VII (2 jours avant l'examen)",
    "Chaque dossier examen comporte le test de fran√ßais (2 jours avant l'examen)",
    "Chaque dossier examen comporte le certificat de r√©alisation (2 jours avant l'examen)",
    "Chaque dossier examen comporte le PV individuel pr√©-rempli (2 jours avant l'examen)",
    "Attestation : pas la m√™me entreprise que jury (2 jours avant l'examen)",
    "Attestation : maitrise de la main courante (2 jours avant l'examen)"
  ],
  "üß™ Organisation de l'examen" : [
    "Le jury chef incendie a √©t√© nomm√© (65 jours avant d√©but de session)",
    "Le lieu d'examen pratique a √©t√© r√©serv√© (65 jours avant d√©but de session)",
    "Les convocations examen envoy√©es (15 jours avant l'examen)",
    "T√©l√©commandes Quizzbox v√©rifi√©es (2 jours avant l'examen)",
    "Logiciel Quizzbox param√©tr√© (2 jours avant l'examen)",
    "PV collectif pr√©-rempli (2 jours avant l'examen)",
    "Salle d'examen th√©orique pr√©par√©e (2 jours avant l'examen)",
    "V√©rification identit√©s (jour J)",
    "PV r√©sultats imprim√© (jour J)",
    "PV individuels photocopi√©s x3 (jour J)",
    "PV collectif photocopi√© x2 (jour J)"
  ],
  "üéì Dipl√¥mes" : [
    "Dipl√¥me avec photo (2 jours apr√®s l'examen)",
    "Num√©ros v√©rifi√©s (2 jours apr√®s l'examen)",
    "Signature directeur (2 jours apr√®s l'examen)",
    "Impression papier 180g (2 jours apr√®s l'examen)",
    "Envoi SDIS LRAR (2 jours apr√®s l'examen)",
    "Validation SDIS (30 jours apr√®s l'examen)",
    "Remise aux candidats (35 jours apr√®s l'examen)",
    "Signature r√©c√©piss√© (35 jours apr√®s l'examen)",
    "Tra√ßabilit√© tableau Excel (2 jours apr√®s l'examen)"
  ],
  "üì¶ Cl√¥ture de session" : [
    "Rapport tra√ßabilit√© g√©n√©r√© (40 jours apr√®s l'examen)",
    "Rapport envoy√© pr√©fecture (40 jours apr√®s l'examen)",
    "Rapport imprim√© et archiv√© (40 jours apr√®s l'examen)"
  ]
} %}

<!-- ========= SOMMAIRE SSIAP ========= -->

<div class="sommaire-ssi">
  <h2 style="margin-bottom:10px;">üìò Sommaire</h2>
  <div class="sommaire-list">
    {% for title, items in sections.items() %}
      {% set total = items|length %}
      {% set done = 0 %}
      {% for entry in sorted_steps %}
        {% if entry.step.name in items and entry.step.done %}
          {% set done = done + 1 %}
        {% endif %}
      {% endfor %}
      <a href="#section_{{ loop.index }}" class="sommaire-item">
        <span>{{ title.split(' ')[0] }}</span> {{ title }} <strong>({{ done }}/{{ total }})</strong>
      </a>
    {% endfor %}
  </div>
</div>

<!-- ========= SECTIONS SSIAP ========= -->

{% for title, items in sections.items() %}
  <h2 id="section_{{ loop.index }}" class="section-title">
    {{ title }}
  </h2>
  <div class="section-line"></div>

  {% for entry in sorted_steps %}
    {% if entry.step.name in items %}
      {% set i = entry.index %}
      {% include 'step_block.html' %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% else %}

<!-- ======================================================================= -->
<!--                  MODE NORMAL (APS / A3P / BTS / GENERAL)                -->
<!--                            VERSION D‚ÄôORIGINE                            -->
<!-- ======================================================================= -->

<div class="filter-bar">
  <label><strong>Afficher :</strong></label>
  <select id="filterSelect">
    <option value="all">Toutes les √©tapes</option>
    <option value="done">‚úÖ Valid√©es</option>
    <option value="notdone">‚è≥ Non valid√©es</option>
  </select>

  <input id="searchInput" type="text" placeholder="üîç Rechercher une √©tape...">

  <button id="resetFiltersBtn" type="button">üßπ R√©initialiser</button>
</div>

<div class="steps" id="stepsContainer">
  {% for entry in sorted_steps %}
    {% set i = entry.index %}
    {% include 'step_block.html' %}
  {% endfor %}
</div>

{% endif %}
{% endif %}

</main>

<footer class="footer">
  ¬© <span id="year"></span> Int√©grale Academy
</footer>

<script>
document.getElementById('year').textContent = new Date().getFullYear();
window.scrollTo(0,0);

// SSESSIONS FILTERING
const STORAGE_KEY = "sessionFilter_{{ s.id }}";
const filterSelect = document.getElementById('filterSelect');
const searchInput = document.getElementById('searchInput');
const steps = document.querySelectorAll(".step");

function applyFilters(){
  if(!filterSelect) return;
  const filter = filterSelect.value;
  const query = searchInput.value.toLowerCase().trim();
  steps.forEach(step=>{
    const isDone = step.dataset.done==="true";
    const name = step.dataset.name||"";
    let visible = true;
    if(filter==="done" && !isDone) visible=false;
    if(filter==="notdone" && isDone) visible=false;
    if(query && !name.includes(query)) visible=false;
    step.classList.toggle("hidden",!visible);
  });
  sessionStorage.setItem(STORAGE_KEY,JSON.stringify({filter,query}));
}

function restoreFilters(){
  if(!filterSelect) return;
  const saved = sessionStorage.getItem(STORAGE_KEY);
  if(!saved) return;
  try{
    const {filter,query}=JSON.parse(saved);
    if(filter) filterSelect.value=filter;
    if(query) searchInput.value=query;
    applyFilters();
  }catch(e){}
}

filterSelect?.addEventListener("change",applyFilters);
searchInput?.addEventListener("input",applyFilters);
document.getElementById("resetFiltersBtn")?.addEventListener("click",()=>{
  filterSelect.value="all";
  searchInput.value="";
  applyFilters();
  sessionStorage.removeItem(STORAGE_KEY);
});
restoreFilters();

// TOGGLE (SSIAP)
let allCollapsed = false;
document.getElementById("toggleAllBtn")?.addEventListener("click", ()=>{
  allCollapsed = !allCollapsed;
  document.querySelectorAll("div.step").forEach(step=>{
    step.style.display = allCollapsed ? "none" : "";
  });
});
</script>

</body>
</html>
