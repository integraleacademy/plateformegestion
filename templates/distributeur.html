<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Gestion du distributeur ‚Äî Int√©grale Academy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      margin:0;
      padding:0;
      font-family: Arial, Helvetica, sans-serif;
      background:#f4f6f8;
      color:#111;
    }
    .page-wrapper{
      max-width:1200px;
      margin:30px auto;
      padding:0 15px 40px;
    }
    .page-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:24px;
      font-weight:700;
      margin-bottom:8px;
    }
    .page-title span.icon{
      width:34px;
      height:34px;
      border-radius:50%;
      background:#111;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:18px;
    }
    .page-subtitle{
      font-size:14px;
      color:#555;
      margin-bottom:20px;
    }

    .bloc-ligne{
      background:#0f172a;
      border-radius:18px;
      padding:18px 20px 22px;
      margin-bottom:20px;
      box-shadow:0 10px 30px rgba(0,0,0,0.15);
      color:#f9fafb;
    }
    .ligne-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    .badge-ligne{
      background:#020617;
      padding:6px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:600;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .ligne-info{
      font-size:13px;
      color:#9ca3af;
    }

    .produits-row{
      display:flex;
      gap:14px;
      overflow-x:auto;
      padding-bottom:6px;
    }
    .produits-row::-webkit-scrollbar{
      height:6px;
    }
    .produits-row::-webkit-scrollbar-thumb{
      background:#475569;
      border-radius:999px;
    }

    .card-produit{
      min-width:260px;
      max-width:260px;
      background:#020617;
      border-radius:14px;
      padding:12px 14px 14px;
      box-shadow:0 6px 14px rgba(0,0,0,0.35);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
    }
    .card-title{
      font-size:13px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:#e5e7eb;
    }
    .trash-btn{
      border:none;
      background:transparent;
      color:#9ca3af;
      cursor:pointer;
      font-size:15px;
    }
    .trash-btn:hover{
      color:#f97373;
    }

    .field-group{
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-top:4px;
    }
    .field-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:#9ca3af;
    }
    .input-line{
      display:flex;
      gap:6px;
    }
    input[type="text"],
    input[type="number"]{
      width:100%;
      box-sizing:border-box;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#020617;
      color:#e5e7eb;
      font-size:13px;
      padding:6px 8px;
      outline:none;
    }
    input[type="number"]{
      text-align:right;
    }
    input:focus{
      border-color:#22c55e;
    }

    .badge-info{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      display:inline-block;
      margin-top:4px;
    }
    .badge-reassort{
      background:#111827;
      color:#fde68a;
    }
    .badge-marge-ok{
      background:#022c22;
      color:#6ee7b7;
    }
    .badge-marge-bad{
      background:#450a0a;
      color:#fecaca;
    }

    .card-add{
      min-width:220px;
      max-width:220px;
      border-radius:14px;
      border:2px dashed #374151;
      background:#020617;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      color:#9ca3af;
      padding:12px;
      cursor:pointer;
      transition:all .15s ease;
      text-align:center;
    }
    .card-add:hover{
      border-color:#22c55e;
      color:#d1fae5;
    }
    .card-add button{
      all:unset;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      width:100%;
      height:100%;
    }
    .card-add-icon{
      width:30px;
      height:30px;
      border-radius:999px;
      border:1px dashed #4b5563;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
    }
    .card-add-text{
      font-size:13px;
    }
    .card-add-ligne{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      opacity:.7;
    }
  </style>
</head>
<body>

<div class="page-wrapper">
  <div class="page-title">
    <span class="icon">üç´</span>
    <span>Gestion du distributeur</span>
  </div>

  <div class="page-subtitle">
    Chaque ligne repr√©sente un √©tage du distributeur. Chaque ‚Äúcase‚Äù correspond √† un produit.
  </div>

  <div style="margin-bottom:20px; text-align:right;">
    <a href="{{ url_for('distributeur_reassort') }}"
       style="background:#22c55e;padding:10px 16px;border-radius:8px;color:#02140a;
              font-weight:600;text-decoration:none;box-shadow:0 4px 8px rgba(0,0,0,0.15);">
        üßÉ Voir le r√©assort
    </a>
  </div>

  {% for ligne in data.lignes %}
    <div class="bloc-ligne">
      <div class="ligne-header">
        <div class="badge-ligne">√âtage {{ loop.index }}</div>
        <div class="ligne-info">
          {% if ligne.produits %}
            {{ ligne.produits|length }} produit(s).
          {% else %}
            Aucun produit.
          {% endif %}
        </div>
      </div>

      <div class="produits-row">
        {% for p in ligne.produits %}
          {% set q_cible = p.qte_cible or 0 %}
          {% set q_actuelle = p.qte_actuelle or 0 %}
          {% set reassort = q_cible - q_actuelle %}
          {% set prix_achat = p.prix_achat or 0 %}
          {% set prix_vente = p.prix_vente or 0 %}
          {% set marge = prix_vente - prix_achat %}
          {% set marge_ok = prix_vente >= prix_achat * 2 %}

          <div class="card-produit">
            <div class="card-header">
              <div class="card-title">Produit</div>

              <form method="post" action="{{ url_for('distributeur_delete', ligne_id=ligne.id, pid=p.id) }}">
                <button type="submit" class="trash-btn">üóë</button>
              </form>
            </div>

            <form method="post" action="{{ url_for('distributeur_update', ligne_id=ligne.id, pid=p.id) }}">
              <div class="field-group">
                <label class="field-label">Nom du produit</label>
                <input type="text" name="nom" value="{{ p.nom }}">
              </div>

              <div class="field-group">
                <label class="field-label">Quantit√©s</label>
                <div class="input-line">
                  <div style="flex:1;">
                    <small>Cible</small>
                    <input type="number" name="qte_cible" value="{{ p.qte_cible }}">
                  </div>
                  <div style="flex:1;">
                    <small>Actuelle</small>
                    <input type="number" name="qte_actuelle" value="{{ p.qte_actuelle }}">
                  </div>
                </div>
                <span class="badge-info badge-reassort">
                  R√©assort √† faire : {{ reassort }}
                </span>
              </div>

              <div class="field-group">
                <label class="field-label">Prix</label>
                <div class="input-line">
                  <div style="flex:1;">
                    <small>Achat</small>
                    <input type="number" name="prix_achat" value="{{ p.prix_achat }}" step="0.01">
                  </div>
                  <div style="flex:1;">
                    <small>Vente</small>
                    <input type="number" name="prix_vente" value="{{ p.prix_vente }}" step="0.01">
                  </div>
                </div>

                {% if prix_achat > 0 %}
                  <span class="badge-info {% if marge_ok %}badge-marge-ok{% else %}badge-marge-bad{% endif %}">
                    Marge : {{ "%.2f"|format(marge) }} ‚Ç¨
                    {% if not marge_ok %} ‚ö†Ô∏è (inf√©rieure √† x2){% endif %}
                  </span>
                {% else %}
                  <span class="badge-info badge-marge-bad">
                    Marge : N/A
                  </span>
                {% endif %}
              </div>
            </form>
          </div>
        {% endfor %}

        <div class="card-add">
          <form method="post" action="{{ url_for('distributeur_add', ligne_id=ligne.id) }}">
            <button type="submit">
              <div class="card-add-icon">+</div>
              <div class="card-add-text">Ajouter un produit</div>
              <div class="card-add-ligne">Ligne {{ ligne.id }}</div>
            </button>
          </form>
        </div>

      </div>
    </div>
  {% endfor %}
</div>

<!-- SCRIPT AUTO SAVE + FIX -->
<script>
function showToastAutoSave() {
  const toast = document.getElementById("autosave-toast");
  toast.style.display = "block";
  setTimeout(() => {
    toast.style.display = "none";
  }, 1200);
}

// AUTO SAVE corrig√©
function autoSave(input) {
  const card = input.closest(".card-produit");

  // ‚ö†Ô∏è IMPORTANT : dans la carte, le 1er form = supprimer, le 2e = sauvegarder
  const forms = card.querySelectorAll("form");
  const form = forms[1];

  const formData = new FormData(form);

  fetch(form.action, {
    method: "POST",
    body: formData
  })
  .then(() => {
    updateLiveCalcul(card);
    showToastAutoSave();
  });
}

// Active auto-save
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".card-produit input").forEach(input => {
    input.addEventListener("input", () => autoSave(input));
  });
});

// Calcul dynamique
function updateLiveCalcul(card) {
  const qC = parseFloat(card.querySelector("input[name='qte_cible']").value) || 0;
  const qA = parseFloat(card.querySelector("input[name='qte_actuelle']").value) || 0;
  const a = parseFloat(card.querySelector("input[name='prix_achat']").value) || 0;
  const v = parseFloat(card.querySelector("input[name='prix_vente']").value) || 0;

  const reassort = qC - qA;
  const marge = v - a;

  card.querySelector(".badge-reassort").textContent =
    "R√©assort √† faire : " + reassort;

  const badge = card.querySelector(".badge-info");

  if (a > 0) {
    badge.textContent = "Marge : " + marge.toFixed(2) + " ‚Ç¨";
    if (v < a * 2) {
      badge.classList.add("badge-marge-bad");
      badge.classList.remove("badge-marge-ok");
      badge.textContent += " ‚ö†Ô∏è (inf√©rieure √† x2)";
    } else {
      badge.classList.add("badge-marge-ok");
      badge.classList.remove("badge-marge-bad");
    }
  } else {
    badge.textContent = "Marge : N/A";
    badge.classList.add("badge-marge-bad");
    badge.classList.remove("badge-marge-ok");
  }
}
</script>

<!-- TOAST -->
<div id="autosave-toast"
     style="position:fixed;top:20px;right:20px;background:#22c55e;
            color:#02140a;padding:10px 18px;font-weight:600;border-radius:8px;
            box-shadow:0 4px 10px rgba(0,0,0,0.15);display:none;z-index:999;">
  ‚úîÔ∏è Sauvegard√© automatiquement
</div>

</body>
</html>
